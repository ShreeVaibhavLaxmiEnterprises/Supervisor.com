<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Tracker</title>
    <style>
        /* CSS Styles */
        body { font-family: sans-serif; background: #f4f4f4; padding: 10px; margin: 0; }
        .container { max-width: 800px; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #d32f2f; margin-bottom: 5px; }
        .btn { width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; font-size: 16px; margin-top: 10px; border-radius: 5px; cursor: pointer; }
        .btn-green { background: #2e7d32; }
        .btn-blue { background: #1976d2; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; box-sizing: border-box; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #ffebee; }
        
        /* Modal (Popup) for Image */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { margin: 20% auto; display: block; max-width: 90%; max-height: 80%; border: 3px solid white; }
        .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }

        /* Tools */
        .worker-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; align-items: center; }
        .hajari-box { width: 60px !important; text-align: center; border: 2px solid #90caf9; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="container">
    <h2>Shree Vaibhav Laxmi Ent.</h2>
    <div style="text-align:center; color:#666; font-size:12px;">Daily Site Report & Hajari</div>

    <div class="no-print" style="margin-top:10px; padding:10px; background:#eee; border-radius:5px;">
        <button class="btn btn-blue" onclick="toggle('workerArea')" style="margin:0;">üõ†Ô∏è Manage Workers / Salary</button>
        
        <div id="workerArea" style="display:none; margin-top:10px;">
            <input type="text" id="newWorker" placeholder="Worker Name">
            <button class="btn btn-green" onclick="addWorker()" style="padding:8px;">Add Worker</button>
            <hr>
            <strong>Salary Calc:</strong>
            <select id="salaryWorker"></select>
            <input type="number" id="salaryRate" placeholder="Daily Rate (‚Çπ)">
            <button class="btn btn-green" onclick="calcSalary()" style="padding:8px;">Calculate</button>
            <p id="salaryResult" style="font-weight:bold; color:green;"></p>
        </div>
    </div>

    <div class="no-print" style="margin-top:20px;">
        <h3>üìù Daily Entry</h3>
        <input type="date" id="date">
        <input type="text" id="site" placeholder="Site Name">
        
        <label>Photo (Optional):</label>
        <input type="file" id="photoInput" accept="image/*">

        <div style="display:flex; gap:5px;">
            <textarea id="matIn" placeholder="Material IN (‡§Ü‡§Ø‡§æ)"></textarea>
            <textarea id="matOut" placeholder="Material OUT (‡§≤‡§ó‡§æ)"></textarea>
        </div>

        <div style="background:#e3f2fd; padding:10px; margin-top:10px;">
            <strong>Worker Hajari:</strong>
            <div id="hajariList"></div>
        </div>

        <button class="btn" onclick="saveReport()">Save Report</button>
    </div>

    <div style="margin-top:20px;">
        <h3>üìã History <button class="btn btn-blue no-print" onclick="window.print()" style="width:auto; padding:5px; font-size:12px;">Print PDF</button></h3>
        <table id="table">
            <thead>
                <tr>
                    <th>Date/Site</th>
                    <th>Photo/Mat</th>
                    <th>Hajari</th>
                    <th class="no-print">X</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<div id="imgModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="imgDisplay">
</div>

<script>
    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('date').valueAsDate = new Date();
        loadWorkers();
        loadReports();
    });

    function toggle(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    // WORKER LOGIC
    function getWorkers() { return JSON.parse(localStorage.getItem('wk_list')) || []; }
    
    function addWorker() {
        const name = document.getElementById('newWorker').value;
        if(name) {
            const list = getWorkers();
            list.push(name);
            localStorage.setItem('wk_list', JSON.stringify(list));
            document.getElementById('newWorker').value = '';
            loadWorkers();
            alert("Worker Added");
        }
    }

    function loadWorkers() {
        const list = getWorkers();
        // Setup Hajari Form
        const hDiv = document.getElementById('hajariList');
        hDiv.innerHTML = '';
        
        // Setup Salary Dropdown
        const sSelect = document.getElementById('salaryWorker');
        sSelect.innerHTML = '<option value="">Select...</option>';

        list.forEach((name, index) => {
            // Form
            hDiv.innerHTML += `
                <div class="worker-row">
                    <span>${name}</span>
                    <input type="number" id="w_${index}" class="hajari-box" placeholder="0">
                </div>`;
            // Dropdown
            sSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });
    }

    // SAVE REPORT
    function saveReport() {
        const date = document.getElementById('date').value;
        const site = document.getElementById('site').value;
        const matIn = document.getElementById('matIn').value;
        const matOut = document.getElementById('matOut').value;
        const workers = getWorkers();

        if(!date || !site) return alert("Date & Site Required");

        // Process Hajari
        let hajariTxt = '';
        let totalH = 0;
        let hajariObj = {}; // For salary calc

        workers.forEach((name, index) => {
            const val = document.getElementById(`w_${index}`).value;
            if(val > 0) {
                hajariTxt += `${name}:${val}, `;
                totalH += parseFloat(val);
                hajariObj[name] = parseFloat(val);
            }
        });

        // Image Handling
        const fileInput = document.getElementById('photoInput');
        if(fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress Image
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 300 / img.width; 
                    canvas.width = 300;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    saveDataFinal(date, site, matIn, matOut, hajariTxt, totalH, hajariObj, canvas.toDataURL('image/jpeg', 0.5));
                }
            }
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            saveDataFinal(date, site, matIn, matOut, hajariTxt, totalH, hajariObj, null);
        }
    }

    function saveDataFinal(date, site, matIn, matOut, hajariTxt, totalH, hajariObj, imgData) {
        const report = { id: Date.now(), date, site, matIn, matOut, hajariTxt, totalH, hajariObj, img: imgData };
        const reports = JSON.parse(localStorage.getItem('reports_v2')) || [];
        reports.push(report);
        if(reports.length > 50) reports.shift(); // Keep limit
        localStorage.setItem('reports_v2', JSON.stringify(reports));
        
        loadReports();
        alert("Saved!");
        // Reset Inputs
        document.getElementById('matIn').value = '';
        document.getElementById('matOut').value = '';
        document.getElementById('photoInput').value = '';
        const inputs = document.querySelectorAll('.hajari-box');
        inputs.forEach(i => i.value = '');
    }

    // LOAD REPORTS
    function loadReports() {
        const reports = JSON.parse(localStorage.getItem('reports_v2')) || [];
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        reports.reverse().forEach(r => {
            let imgBtn = r.img ? `<button onclick="showImg('${r.img}')" style="background:#4caf50; padding:2px 5px; width:auto; font-size:10px;">View Photo</button>` : '';
            let mat = (r.matIn ? `<div style="color:green">In:${r.matIn}</div>` : '') + (r.matOut ? `<div style="color:red">Out:${r.matOut}</div>` : '');
            
            tbody.innerHTML += `
                <tr>
                    <td><b>${r.date}</b><br>${r.site}</td>
                    <td>${imgBtn}<br>${mat}</td>
                    <td>${r.hajariTxt}<br><b>Total: ${r.totalH}</b></td>
                    <td class="no-print"><button onclick="del(${r.id})" style="background:red; color:white; border:none;">X</button></td>
                </tr>
            `;
        });
    }

    // UTILS
    function del(id) {
        if(confirm("Delete?")) {
            let reports = JSON.parse(localStorage.getItem('reports_v2')) || [];
            reports = reports.filter(r => r.id !== id);
            localStorage.setItem('reports_v2', JSON.stringify(reports));
            loadReports();
        }
    }

    function showImg(src) {
        document.getElementById('imgDisplay').src = src;
        document.getElementById('imgModal').style.display = "block";
    }

    function closeModal() {
        document.getElementById('imgModal').style.display = "none";
    }

    function calcSalary() {
        const name = document.getElementById('salaryWorker').value;
        const rate = document.getElementById('salaryRate').value;
        if(!name || !rate) return;
        
        let days = 0;
        const reports = JSON.parse(localStorage.getItem('reports_v2')) || [];
        reports.forEach(r => {
            if(r.hajariObj && r.hajariObj[name]) days += r.hajariObj[name];
        });
        
        document.getElementById('salaryResult').innerText = `Days: ${days} | Pay: ‚Çπ${days * rate}`;
    }
</script>

</body>
  </html>
