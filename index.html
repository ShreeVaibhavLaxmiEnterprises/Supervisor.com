<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            padding-bottom: 50px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .header-title {
            color: #dc3545;
            font-weight: 800;
            text-align: center;
            padding: 20px 0;
            font-size: 24px;
        }

        /* Section Styling */
        .card-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px;
            background: #fff;
            position: relative;
        }
        .sec-title { font-weight: 700; font-size: 18px; margin-bottom: 15px; }
        .text-green { color: #198754; }
        .text-orange { color: #fd7e14; }
        .text-purple { color: #6f42c1; }

        /* Buttons */
        .btn-full { width: 100%; font-weight: bold; margin-bottom: 10px; }
        .btn-blue { background-color: #0d6efd; color: white; }
        .btn-green { background-color: #198754; color: white; }
        .btn-orange { background-color: #fd7e14; color: white; }
        .btn-purple { background-color: #6f42c1; color: white; }
        .btn-red { background-color: #dc3545; color: white; }

        /* Worker Hajari Row */
        .worker-row {
            background-color: #f1f8ff;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid #0d6efd;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .worker-row input[type="number"] {
            padding: 5px;
            font-size: 14px;
        }

        /* Image Preview */
        .img-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .img-preview-lg {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            display: none;
            margin-top: 10px;
            border: 1px solid #ccc;
        }

        /* Bill Modal Styling (Like Screenshot) */
        #billOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        .bill-card {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 16px; }
        .bill-total { font-size: 20px; font-weight: bold; color: #dc3545; text-align: center; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;}

        /* Print Logic */
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-title">Shree Vaibhav Laxmi Ent.</div>

    <div style="padding: 0 15px;">
        <button class="btn btn-blue btn-full" onclick="openWorkerModal()">+ Worker Add / Remove</button>
        <div id="workerCountLabel" class="text-muted small mb-2 text-center">No workers.</div>
    </div>

    <div class="card-section">
        <div class="sec-title text-green">1. Daily Work Entry</div>
        
        <input type="date" id="workDate" class="form-control mb-2">
        <input type="text" id="siteName" class="form-control mb-2" placeholder="Site Name">

        <div class="mb-3">
            <label class="form-label fw-bold">Worker Hajari & Advance:</label>
            <div id="hajariList" class="small text-muted">
                Add workers first.
            </div>
        </div>

        <div class="row g-2 mb-2">
            <div class="col-6"><input type="text" id="maalIn" class="form-control" placeholder="Maal Aaya (IN)"></div>
            <div class="col-6"><input type="text" id="maalOut" class="form-control" placeholder="Maal Laga (OUT)"></div>
        </div>

        <textarea id="workDetails" class="form-control mb-2" rows="2" placeholder="Kaam ki details..."></textarea>

        <div class="mb-2">
            <strong>Photo:</strong>
            <input type="file" id="photoInput" class="form-control" accept="image/*" onchange="previewImage()">
            <img id="imgPreview" class="img-preview-lg" src="">
        </div>

        <button class="btn btn-green btn-full" onclick="saveWork()">Save Record</button>
    </div>

    <div class="card-section">
        <div class="sec-title text-orange">2. Payment Entry (Cash)</div>
        <select id="payWorkerSelect" class="form-select mb-2">
            <option value="">Select Worker...</option>
        </select>
        <div class="row g-2 mb-2">
            <div class="col-6"><input type="date" id="payDate" class="form-control"></div>
            <div class="col-6"><input type="number" id="payAmount" class="form-control" placeholder="Amount ₹"></div>
        </div>
        <button class="btn btn-orange btn-full" onclick="savePayment()">Save Payment</button>
    </div>

    <div class="card-section">
        <div class="sec-title text-purple">3. Generate Hisab</div>
        <select id="billWorkerSelect" class="form-select mb-2">
            <option value="">Select Worker...</option>
        </select>
        <button class="btn btn-purple btn-full" onclick="generateBill()">Generate Bill</button>
    </div>

    <div class="card-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="sec-title mb-0">Saved Records</div>
            <button class="btn btn-sm btn-outline-dark" onclick="printReport()">Print Report</button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered table-sm" style="font-size:13px;">
                <thead class="table-light">
                    <tr>
                        <th>Date/Site</th>
                        <th>Detail</th>
                        <th>Img</th>
                        <th>Act</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-red btn-full mt-2" onclick="resetAllData()">RESET ALL DATA</button>
    </div>
</div>

<div class="modal fade" id="workerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Workers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Add New:</h6>
                <div class="input-group mb-3">
                    <input type="text" id="newWorkerName" class="form-control" placeholder="Name">
                    <input type="number" id="newWorkerRate" class="form-control" placeholder="Rate ₹" style="max-width: 100px;">
                    <button class="btn btn-primary" onclick="addWorker()">Add</button>
                </div>
                <hr>
                <h6>Existing Workers (Click X to remove):</h6>
                <ul id="modalWorkerList" class="list-group">
                    </ul>
            </div>
        </div>
    </div>
</div>

<div id="billOverlay">
    <div class="bill-card">
        <h4 class="text-center fw-bold text-uppercase mb-3">Shree Vaibhav Laxmi Ent.</h4>
        <div class="text-center mb-2 border-bottom pb-2" id="billStatementName">Statement: -</div>
        
        <div class="bill-row">
            <strong>Total Days:</strong>
            <span id="bTotalDays">0</span>
        </div>
        <div class="bill-row text-success">
            <strong>Total Kamayi:</strong>
            <span id="bTotalKamayi">₹0</span>
        </div>
        <div class="bill-row text-danger">
            <strong>(-) Daily Advance:</strong>
            <span id="bTotalAdvance">₹0</span>
        </div>
        <div class="bill-row text-danger">
            <strong>(-) Cash Given:</strong>
            <span id="bTotalCash">₹0</span>
        </div>

        <div class="bill-total" id="bFinalBalance">
            BAKI (Balance): ₹0
        </div>

        <div class="mt-3">
            <button class="btn btn-primary w-100 mb-2" onclick="printBill()">Print</button>
            <button class="btn btn-danger w-100" onclick="closeBill()">Close</button>
        </div>
        
        <div id="billDetailsHidden" style="display:none;"></div>
    </div>
</div>

<div id="printableArea"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // State
    let workers = JSON.parse(localStorage.getItem('svl_workers')) || [];
    let records = JSON.parse(localStorage.getItem('svl_records')) || [];

    window.onload = function() {
        document.getElementById('workDate').valueAsDate = new Date();
        document.getElementById('payDate').valueAsDate = new Date();
        renderAll();
    };

    // --- Worker Management ---
    const workerModal = new bootstrap.Modal(document.getElementById('workerModal'));
    function openWorkerModal() {
        renderModalList();
        workerModal.show();
    }

    function addWorker() {
        const name = document.getElementById('newWorkerName').value;
        const rate = document.getElementById('newWorkerRate').value;
        if(!name || !rate) return alert("Name and Rate required");

        workers.push({ id: Date.now(), name: name, rate: parseFloat(rate) });
        saveWorkers();
        document.getElementById('newWorkerName').value = '';
        renderModalList();
        renderAll();
    }

    function removeWorker(id) {
        if(confirm("Delete this worker? History will remain but new entries won't show them.")) {
            workers = workers.filter(w => w.id !== id);
            saveWorkers();
            renderModalList();
            renderAll();
        }
    }

    function saveWorkers() { localStorage.setItem('svl_workers', JSON.stringify(workers)); }

    function renderModalList() {
        const list = document.getElementById('modalWorkerList');
        list.innerHTML = "";
        workers.forEach(w => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${w.name} (₹${w.rate})
                    <button class="btn btn-sm btn-danger" onclick="removeWorker(${w.id})">X</button>
                </li>
            `;
        });
    }

    // --- Main UI Rendering ---
    function renderAll() {
        // 1. Hajari List
        const hList = document.getElementById('hajariList');
        if(workers.length === 0) {
            hList.innerHTML = "Add workers first.";
            document.getElementById('workerCountLabel').innerText = "No workers.";
        } else {
            document.getElementById('workerCountLabel').innerText = `Workers: ${workers.length}`;
            hList.innerHTML = "";
            workers.forEach(w => {
                hList.innerHTML += `
                    <div class="worker-row">
                        <div class="form-check" style="width: 35%;">
                            <input class="form-check-input w-check" type="checkbox" value="${w.id}" id="wc_${w.id}" onchange="toggleInputs(${w.id})">
                            <label class="form-check-label text-truncate" for="wc_${w.id}" style="font-weight:600;">${w.name}</label>
                        </div>
                        <input type="number" id="att_${w.id}" class="form-control form-control-sm" placeholder="Hajari (1)" value="1" step="0.5" disabled style="width: 25%;">
                        <input type="number" id="adv_${w.id}" class="form-control form-control-sm" placeholder="Adv ₹" disabled style="width: 35%;">
                    </div>
                `;
            });
        }

        // 2. Dropdowns
        const pSel = document.getElementById('payWorkerSelect');
        const bSel = document.getElementById('billWorkerSelect');
        let opts = '<option value="">Select Worker...</option>';
        workers.forEach(w => { opts += `<option value="${w.id}">${w.name}</option>`; });
        pSel.innerHTML = opts;
        bSel.innerHTML = opts;

        // 3. Records Table
        renderTable();
    }

    function toggleInputs(id) {
        const checked = document.getElementById(`wc_${id}`).checked;
        document.getElementById(`att_${id}`).disabled = !checked;
        document.getElementById(`adv_${id}`).disabled = !checked;
    }

    // --- Image Handling ---
    let currentImg = null;
    function previewImage() {
        const file = document.getElementById('photoInput').files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImg = e.target.result;
            document.getElementById('imgPreview').src = currentImg;
            document.getElementById('imgPreview').style.display = 'block';
        };
        if(file) reader.readAsDataURL(file);
    }

    // --- Save Logic ---
    function saveWork() {
        const date = document.getElementById('workDate').value;
        const site = document.getElementById('siteName').value;
        const checks = document.querySelectorAll('.w-check:checked');
        
        if(checks.length === 0 && !site) return alert("Fill site name or select workers.");

        let workerDetails = [];
        checks.forEach(c => {
            const wid = parseInt(c.value);
            const wObj = workers.find(w => w.id === wid);
            const att = parseFloat(document.getElementById(`att_${wid}`).value) || 0;
            const adv = parseFloat(document.getElementById(`adv_${wid}`).value) || 0;
            
            workerDetails.push({
                id: wid,
                name: wObj.name,
                rate: wObj.rate,
                attendance: att, // 1 or 0.5
                advance: adv     // Daily kharcha specific to this worker
            });
        });

        const record = {
            id: Date.now(),
            type: 'WORK',
            date: date,
            site: site,
            workers: workerDetails, // Complex array
            in: document.getElementById('maalIn').value,
            out: document.getElementById('maalOut').value,
            details: document.getElementById('workDetails').value,
            img: currentImg
        };

        records.push(record);
        updateStorage();
        resetForm();
        alert("Work Saved!");
    }

    function savePayment() {
        const wid = document.getElementById('payWorkerSelect').value;
        const amt = document.getElementById('payAmount').value;
        if(!wid || !amt) return alert("Missing fields");
        const wName = workers.find(w => w.id == wid).name;

        records.push({
            id: Date.now(),
            type: 'PAY',
            date: document.getElementById('payDate').value,
            workerId: parseInt(wid),
            workerName: wName,
            amount: parseFloat(amt)
        });
        updateStorage();
        document.getElementById('payAmount').value = '';
        renderTable();
        alert("Payment Saved!");
    }

    function resetForm() {
        document.getElementById('siteName').value = '';
        document.getElementById('maalIn').value = '';
        document.getElementById('maalOut').value = '';
        document.getElementById('workDetails').value = '';
        document.getElementById('photoInput').value = '';
        document.getElementById('imgPreview').style.display = 'none';
        currentImg = null;
        renderAll(); // Resets checkboxes
    }

    // --- Table & Delete ---
    function renderTable() {
        const tbody = document.getElementById('recordsTableBody');
        tbody.innerHTML = "";
        
        [...records].reverse().forEach(r => {
            let row = "";
            if(r.type === 'WORK') {
                let wNames = r.workers.map(w => {
                    let txt = w.name;
                    if(w.attendance !== 1) txt += `(${w.attendance})`;
                    if(w.advance > 0) txt += `[-₹${w.advance}]`;
                    return txt;
                }).join(", ");
                
                let imgTag = r.img ? `<img src="${r.img}" class="img-thumb" onclick="viewImg('${r.img}')">` : '-';

                row = `<tr>
                    <td><b>${r.date}</b><br>${r.site}</td>
                    <td><small class="text-primary">${wNames}</small><br>${r.details}<br><small>IN:${r.in} OUT:${r.out}</small></td>
                    <td>${imgTag}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="delRec(${r.id})">X</button></td>
                </tr>`;
            } else {
                row = `<tr class="table-warning">
                    <td><b>${r.date}</b><br>Payment</td>
                    <td>To: <b>${r.workerName}</b><br>Amount: ₹${r.amount}</td>
                    <td>-</td>
                    <td><button class="btn btn-sm btn-danger" onclick="delRec(${r.id})">X</button></td>
                </tr>`;
            }
            tbody.innerHTML += row;
        });
    }

    function delRec(id) {
        if(confirm("Delete record?")) {
            records = records.filter(r => r.id !== id);
            updateStorage();
            renderTable();
        }
    }
    
    function updateStorage() { localStorage.setItem('svl_records', JSON.stringify(records)); }

    function viewImg(src) {
        let w = window.open("");
        w.document.write(`<img src="${src}" style="width:100%">`);
    }

    // --- BILL GENERATION (The Core Request) ---
    function generateBill() {
        const wid = parseInt(document.getElementById('billWorkerSelect').value);
        if(!wid) return alert("Select a worker");
        const worker = workers.find(w => w.id === wid);

        let tDays = 0, tKamayi = 0, tAdv = 0, tCash = 0;
        let detailHtml = `<table style="width:100%; border-collapse: collapse; margin-top:20px; font-size:12px;" border="1">
            <tr style="background:#eee;"><th>Date</th><th>Detail</th><th>Amt</th></tr>`;

        records.forEach(r => {
            if(r.type === 'WORK') {
                // Find if this worker worked this day
                const wData = r.workers.find(w => w.id === wid);
                if(wData) {
                    const dailyWage = wData.attendance * wData.rate;
                    tDays += wData.attendance;
                    tKamayi += dailyWage;
                    tAdv += wData.advance; // The specific advance for this day

                    // Add row to detail table
                    let desc = `Work: ${r.site} (${wData.attendance} day)`;
                    if(wData.advance > 0) desc += `<br><span style="color:red">Adv taken: -${wData.advance}</span>`;
                    
                    detailHtml += `<tr><td style="padding:5px;">${r.date}</td><td style="padding:5px;">${desc}</td><td style="
