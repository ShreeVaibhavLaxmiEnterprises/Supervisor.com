<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shree Vaibhav Laxmi Tracker Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 10px; color: #333; }
        
        /* --- MAIN APP STYLES --- */
        .container { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        
        h2 { color: #d32f2f; text-align: center; margin-top: 0; text-transform: uppercase; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .subtitle { text-align: center; color: #666; font-size: 0.9em; margin-top: -10px; margin-bottom: 20px; }

        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        label { font-weight: bold; font-size: 0.9em; margin-bottom: 5px; display: block; }

        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; color: white; margin-top: 5px; font-weight: bold; }
        .btn-blue { background: #1976d2; }
        .btn-green { background: #2e7d32; } 
        .btn-orange { background: #f57c00; color: black; }
        .btn-grey { background: #555; }
        .btn-red { background: #c62828; width: auto; padding: 5px 10px; font-size: 12px; }

        .section-box { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; background: #fafafa; border-radius: 5px; }
        .section-title { background: #eee; padding: 8px; font-weight: bold; margin-bottom: 10px; border-left: 5px solid #1976d2; }

        .worker-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; border-bottom: 1px solid #eee; margin-bottom: 5px; }
        .worker-row input { width: 80px; text-align: center; margin-bottom: 0; border: 2px solid #90caf9; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: top;}
        th { background: #e3f2fd; }

        /* --- PRINT SYSTEMS --- */
        .print-template { display: none; background: white; padding: 20px; border: 2px solid black; max-width: 100%; box-sizing: border-box; }
        
        .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 14px; }
        .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .print-logo { font-size: 24px; font-weight: bold; color: #d32f2f; text-transform: uppercase; }
        
        /* Printing Rules */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            #mainApp { display: none !important; } 
            .print-active { display: block !important; position: absolute; top: 0; left: 0; width: 100%; border: none; }
            .no-print { display: none !important; }
            img { max-width: 100% !important; page-break-inside: avoid; }
            table, tr, td, th { page-break-inside: avoid; }
            .print-section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div class="container" id="mainApp">
    <h2>Shree Vaibhav Laxmi Enterprises</h2>
    <p class="subtitle">Supervisor: Siddharth Yadav</p>

    <div id="errorBox" style="display:none; background:#ffcdd2; color:red; padding:10px; border:1px solid red; margin-bottom:10px;"></div>

    <button type="button" class="btn-grey" onclick="toggleDisplay('workerFormArea')">
        + Worker Add / List Check Karein
    </button>
    
    <div id="workerFormArea" class="section-box" style="display:none; margin-top:10px;">
        <h4 style="margin-top:0;">Naya Worker Jodein</h4>
        <div style="display:flex; gap:5px;">
            <input type="text" id="wName" placeholder="Naam" style="flex:2;">
            <input type="number" id="wRate" placeholder="Rate â‚¹" style="flex:1;">
        </div>
        <select id="wType">
            <option value="Mistri">Mistri</option>
            <option value="Helper">Helper</option>
        </select>
        <button type="button" class="btn-green" onclick="addNewWorker()">Save Worker</button>
        
        <hr>
        <h4>Worker List:</h4>
        <ul id="workerListUL" style="padding-left:20px; font-size:0.9em;"></ul>
    </div>

    <div class="section-box" style="margin-top:20px;">
        <div class="section-title">Daily Entry (Roz ka Kaam)</div>
        
        <label>Date:</label>
        <input type="date" id="entryDate">
        
        <label>Site Name:</label>
        <input type="text" id="siteName" placeholder="Site ka naam...">

        <label style="background:#e3f2fd; padding:5px;">Worker Hajari (Attendance):</label>
        <div id="hajariListArea">
            <p style="color:#666; text-align:center;">Loading Workers...</p>
        </div>
        <small>* 1 = Full Day, 0.5 = Half Day</small>

        <label style="margin-top:10px;">Material IN (Aaya):</label>
        <textarea id="matIn" rows="2" placeholder="Cement, Reti etc..."></textarea>
        
        <label>Material OUT (Laga):</label>
        <textarea id="matOut" rows="2" placeholder="Kahan use hua..."></textarea>

        <label>Work Description & Photo:</label>
        <textarea id="workDesc" rows="2" placeholder="Aaj kya kaam hua..."></textarea>
        <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(this)">
        <input type="hidden" id="photoBase64">
        <img id="photoPreview" style="max-width:100px; display:none; margin-top:5px; border:1px solid #ccc;">

        <button type="button" class="btn-green" style="padding: 15px; font-size: 1.1em;" id="mainSaveBtn" onclick="saveAndGeneratePDF()">
            ðŸ’¾ SAVE RECORD & GENERATE PDF
        </button>
    </div>

    <div class="section-box" style="border-left: 5px solid #9c27b0;">
        <div class="section-title" style="background:none; border:none; padding:0; margin:0;">
            Worker Hisab (Payment Bill)
        </div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="date" id="calcFrom">
            <input type="date" id="calcTo">
        </div>
        <select id="calcWorkerSelect" style="margin-top:5px;">
            <option value="">Select Worker...</option>
        </select>
        <button type="button" class="btn-blue" style="background:#9c27b0;" onclick="doCalculation()">Check Hisab</button>

        <div id="calcResult" style="display:none; background:#f3e5f5; padding:10px; margin-top:10px; border-radius:5px;">
            <h3 id="resName" style="margin:0;"></h3>
            <p id="resRange" style="font-size:0.8em; color:#666;"></p>
            <p>Total Hajari: <b id="resHajari">0</b></p>
            <p>Total Amount: <b id="resMoney" style="color:green; font-size:1.2em;">â‚¹0</b></p>
            
            <button type="button" class="btn-orange" onclick="openPaymentBill()">Generate Payment PDF</button>
        </div>
    </div>

    <div class="section-box">
        <div class="section-title">Saved Records</div>
        <div style="overflow-x:auto;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date/Site</th>
                        <th>Details</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="dailyReportTemplate" class="print-template">
    <div class="print-header">
        <div class="print-logo">SHREE VAIBHAV LAXMI ENTERPRISES</div>
        <div>Supervisor: Siddharth Yadav</div>
        <div style="margin-top:5px; font-size: 18px; font-weight: bold; text-decoration: underline;">DAILY SITE REPORT</div>
    </div>

    <table style="width:100%; margin-bottom: 20px;">
        <tr>
            <td style="border:none; width: 50%;"><strong>Date:</strong> <span id="drDate"></span></td>
            <td style="border:none; width: 50%; text-align:right;"><strong>Site Name:</strong> <span id="drSite"></span></td>
        </tr>
    </table>

    <div class="print-section">
        <div style="background:#eee; padding:5px; font-weight:bold; border:1px solid #000;">MATERIAL DETAILS</div>
        <table class="print-table">
            <tr>
                <th style="width:50%; color:green;">IN (Aaya)</th>
                <th style="width:50%; color:red;">OUT (Laga)</th>
            </tr>
            <tr>
                <td id="drMatIn" style="vertical-align:top; height:50px;"></td>
                <td id="drMatOut" style="vertical-align:top; height:50px;"></td>
            </tr>
        </table>
    </div>

    <div class="print-section" style="margin-top:15px;">
        <div style="background:#eee; padding:5px; font-weight:bold; border:1px solid #000;">WORKER ATTENDANCE (HAJARI)</div>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Worker Name</th>
                    <th style="text-align:center;">Type</th>
                    <th style="text-align:center;">Attendance</th>
                    <th style="text-align:right;">Daily Cost (â‚¹)</th>
                </tr>
            </thead>
            <tbody id="drWorkerTable"></tbody>
            <tfoot>
                <tr style="background:#f9f9f9;">
                    <td colspan="3" style="text-align:right; font-weight:bold;">Total Daily Labor Cost:</td>
                    <td style="text-align:right; font-weight:bold;">â‚¹<span id="drTotalCost"></span></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="print-section" style="margin-top:15px;">
        <div style="background:#eee; padding:5px; font-weight:bold; border:1px solid #000;">WORK DESCRIPTION</div>
        <div id="drWorkDesc" style="border:1px solid #000; padding:10px; min-height: 50px;"></div>
    </div>

    <div id="drPhotoArea" class="print-section" style="margin-top:15px; text-align:center; display:none;">
        <div style="background:#eee; padding:5px; font-weight:bold; border:1px solid #000; margin-bottom:5px; text-align:left;">SITE PHOTO</div>
        <img id="drPhoto" src="" style="max-height: 400px; border:1px solid #ccc;">
    </div>

    <div class="no-print" style="margin-top:30px; text-align:center;">
        <button class="btn-green" onclick="window.print()">PRINT PDF</button>
        <button class="btn-red" onclick="closePrintView()">CLOSE</button>
    </div>
</div>

<div id="paymentBillTemplate" class="print-template">
    <div class="print-header">
        <div class="print-logo">SHREE VAIBHAV LAXMI ENTERPRISES</div>
        <div>Shuttering & Construction Contractor</div>
        <div>Supervisor: Siddharth Yadav</div>
    </div>
    
    <div style="text-align:center; font-size:20px; font-weight:bold; text-decoration:underline; margin: 20px 0;">PAYMENT VOUCHER</div>

    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border:1px solid #000; padding:10px;">
        <div style="line-height: 1.6;">
            <strong>To Worker:</strong> <span id="pbName" style="font-size:1.2em;"></span><br>
            <strong>Duration:</strong> <span id="pbRange"></span>
        </div>
        <div style="text-align:right; line-height: 1.6;">
            <strong>Date:</strong> <span id="pbDate"></span><br>
            <strong>Status:</strong> Generated
        </div>
    </div>

    <table class="print-table">
        <tr style="background:#eee;">
            <th>Description</th>
            <th style="text-align:center;">Quantity / Days</th>
            <th style="text-align:right;">Amount (â‚¹)</th>
        </tr>
        <tr>
            <td style="padding:20px 10px;">Total Duty (Hajari)</td>
            <td style="text-align:center; padding:20px 10px;"><span id="pbHajari"></span> Days</td>
            <td style="text-align:right; padding:20px 10px;">-</td>
        </tr>
        <tr style="font-size: 1.2em;">
            <td style="font-weight:bold;">NET PAYABLE AMOUNT</td>
            <td></td>
            <td style="text-align:right; font-weight:bold;">â‚¹<span id="pbAmt"></span></td>
        </tr>
    </table>

    <div style="margin-top:80px; display:flex; justify-content:space-between;">
        <div style="text-align:center; width:40%; border-top:1px dashed black; padding-top:5px;">Worker Signature</div>
        <div style="text-align:center; width:40%; border-top:1px dashed black; padding-top:5px;">Supervisor Signature</div>
    </div>

    <div class="no-print" style="margin-top:30px; text-align:center;">
        <button class="btn-green" onclick="window.print()">PRINT PDF</button>
        <button class="btn-red" onclick="closePrintView()">CLOSE</button>
    </div>
</div>

<script>
    // --- ERROR HANDLING & CRASH PROTECTION ---
    window.onerror = function(msg, url, line) {
        let box = document.getElementById('errorBox');
        box.style.display = 'block';
        box.innerHTML = "Error: " + msg + "<br>Agar memory full hai to purana record delete karein.";
        // Reset button text if crash happens
        document.getElementById('mainSaveBtn').innerHTML = "ðŸ’¾ SAVE RECORD & GENERATE PDF";
    };

    let workers = [];
    let records = [];
    let currentBillData = {};

    function init() {
        try {
            const w = localStorage.getItem('svle_workers_final');
            const r = localStorage.getItem('svle_records_final');
            if(w) workers = JSON.parse(w);
            if(r) records = JSON.parse(r);
            
            // Safe date set
            try { document.getElementById('entryDate').valueAsDate = new Date(); } catch(e){}
            
            renderWorkerList();
            renderHajariForm();
            renderCalcDropdown();
            renderTable();
        } catch(e) { console.error("Init Error", e); }
    }

    // Toggle
    function toggleDisplay(id) {
        let el = document.getElementById(id);
        el.style.display = (el.style.display === "none") ? "block" : "none";
    }

    // Workers
    function addNewWorker() {
        let name = document.getElementById('wName').value;
        let type = document.getElementById('wType').value;
        let rate = document.getElementById('wRate').value;

        if(!name) { alert("Naam jaruri hai"); return; }

        workers.push({ id: Date.now(), name, type, rate: rate || 0 });
        saveData(); // Safe save
        
        document.getElementById('wName').value = "";
        document.getElementById('wRate').value = "";
        
        renderWorkerList();
        renderHajariForm();
        renderCalcDropdown();
        alert("Worker Added!");
    }

    function deleteWorker(id) {
        if(confirm("Delete worker?")) {
            workers = workers.filter(w => w.id !== id);
            saveData();
            renderWorkerList();
            renderHajariForm();
            renderCalcDropdown();
        }
    }

    function renderWorkerList() {
        let ul = document.getElementById('workerListUL');
        ul.innerHTML = "";
        workers.forEach(w => {
            ul.innerHTML += `<li>${w.name} (${w.type}) - â‚¹${w.rate} <span style="color:red; cursor:pointer;" onclick="deleteWorker(${w.id})">[X]</span></li>`;
        });
    }

    // Photo
    function handlePhoto(input) {
        if (input.files && input.files[0]) {
            // CHECK SIZE (Limit 1MB)
            if(input.files[0].size > 1000000) {
                alert("Photo bahut badi hai! Save nahi hogi. Kripya choti photo lein.");
                input.value = "";
                return;
            }

            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('photoBase64').value = e.target.result;
                document.getElementById('photoPreview').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // DAILY RECORD & PDF LOGIC
    function renderHajariForm() {
        let div = document.getElementById('hajariListArea');
        div.innerHTML = "";
        if(workers.length === 0) { div.innerHTML = "No workers."; return; }
        workers.forEach(w => {
            div.innerHTML += `
                <div class="worker-row">
                    <span>${w.name} <small>(${w.type})</small></span>
                    <input type="number" step="0.5" id="att_${w.id}" placeholder="0">
                </div>`;
        });
    }

    function saveAndGeneratePDF() {
        let btn = document.getElementById('mainSaveBtn');
        btn.innerHTML = "â³ Saving..."; // Feedback

        let date = document.getElementById('entryDate').value;
        let site = document.getElementById('siteName').value;
        
        if(!date || !site) { 
            alert("Date aur Site Name bharna jaruri hai"); 
            btn.innerHTML = "ðŸ’¾ SAVE RECORD & GENERATE PDF";
            return; 
        }

        // 1. Collect Data
        let attendance = [];
        let totalPay = 0;
        workers.forEach(w => {
            let inp = document.getElementById('att_' + w.id);
            if(inp && inp.value > 0) {
                let val = parseFloat(inp.value);
                let pay = val * parseFloat(w.rate);
                attendance.push({ name: w.name, type: w.type, val: val, pay: pay });
                totalPay += pay;
            }
        });

        let newRecord = {
            id: Date.now(),
            date: date,
            site: site,
            matIn: document.getElementById('matIn').value,
            matOut: document.getElementById('matOut').value,
            workDesc: document.getElementById('workDesc').value,
            photo: document.getElementById('photoBase64').value,
            attendance: attendance,
            totalPay: totalPay
        };

        // 2. TRY SAVING (With Error Handling)
        try {
            records.unshift(newRecord); // Add to top
            localStorage.setItem('svle_workers_final', JSON.stringify(workers));
            localStorage.setItem('svle_records_final', JSON.stringify(records));
        } catch(e) {
            alert("Storage Full Error! Purane record delete karein ya photo na lagayein.");
            records.shift(); // Undo adding the record
            btn.innerHTML = "ðŸ’¾ SAVE RECORD & GENERATE PDF";
            return;
        }
        
        // 3. Update Table immediately
        renderTable();

        // 4. Alert & Reset
        // alert("Saved! PDF ban raha hai..."); // Optional: removed to make flow faster

        document.getElementById('matIn').value = "";
        document.getElementById('matOut').value = "";
        document.getElementById('workDesc').value = "";
        document.getElementById('photoBase64').value = "";
        document.getElementById('photoInput').value = "";
        document.getElementById('photoPreview').style.display = "none";
        workers.forEach(w => {
            let inp = document.getElementById('att_' + w.id);
            if(inp) inp.value = "";
        });

        btn.innerHTML = "ðŸ’¾ SAVE RECORD & GENERATE PDF"; // Reset Button

        // 5. GENERATE PDF
        generateDailyReport(newRecord);
    }

    function generateDailyReport(rec) {
        // Fill Report Template
        document.getElementById('drDate').innerText = rec.date;
        document.getElementById('drSite').innerText = rec.site;
        document.getElementById('drMatIn').innerText = rec.matIn || "Nil";
        documen
