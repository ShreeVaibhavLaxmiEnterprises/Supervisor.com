<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        
        /* App Container */
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding-bottom: 50px;
        }

        /* Header */
        .app-header {
            text-align: center;
            padding: 20px 10px;
        }
        .company-name {
            color: #dc3545; /* Red */
            font-weight: 700;
            font-size: 24px;
            margin: 0;
        }

        /* Section Cards */
        .card-box {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px;
            background: #fff;
        }
        .section-title {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .title-green { color: #198754; }
        .title-orange { color: #fd7e14; }
        .title-purple { color: #6f42c1; }

        /* Buttons */
        .btn-blue-block { background-color: #0d6efd; color: white; width: 100%; font-weight: bold; margin: 10px 0; }
        .btn-green-block { background-color: #198754; color: white; width: 100%; font-weight: bold; }
        .btn-orange-block { background-color: #fd7e14; color: white; width: 100%; font-weight: bold; }
        .btn-purple-block { background-color: #6f42c1; color: white; width: 100%; font-weight: bold; }
        .btn-red-block { background-color: #dc3545; color: white; width: 100%; font-weight: bold; }

        /* Hajari Box */
        .hajari-container {
            background-color: #e7f1ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #0d6efd;
        }

        /* Image Preview */
        .img-preview {
            width: 100%;
            max-height: 150px;
            object-fit: contain;
            display: none;
            margin-top: 5px;
            border: 1px solid #ccc;
        }

        /* Table */
        .table-custom th { background-color: #f2f2f2; }
        .table-custom img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }

        /* Bill Styles (Hidden by default) */
        #billModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .bill-paper {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Print Specifics */
        @media print {
            body * { visibility: hidden; }
            #billContent, #billContent * { visibility: visible; }
            #billModal { position: absolute; left: 0; top: 0; background: white; display: block; }
            .bill-paper { box-shadow: none; width: 100%; max-width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h1 class="company-name">Shree Vaibhav Laxmi Ent.</h1>
    </div>

    <div style="padding: 0 15px;">
        <button class="btn btn-blue-block" onclick="openWorkerModal()">+ Worker Add Karein</button>
        <div id="workerListLabel" class="text-muted small mb-2">No workers.</div>
    </div>

    <div class="card-box">
        <div class="section-title title-green">1. Daily Work Entry</div>
        
        <input type="date" id="workDate" class="form-control mb-2">
        <input type="text" id="siteName" class="form-control mb-2" placeholder="Site Name">

        <div class="hajari-container">
            <strong>Worker Hajari:</strong>
            <div id="workerCheckboxes">
                <small>Add workers first.</small>
            </div>
        </div>

        <input type="number" id="dailyExpense" class="form-control mb-2" placeholder="Daily Advance/Kharcha (Total) ₹">

        <div class="row g-2 mb-2">
            <div class="col-6"><input type="number" id="maalIn" class="form-control" placeholder="Maal Aaya (IN)"></div>
            <div class="col-6"><input type="number" id="maalOut" class="form-control" placeholder="Maal Laga (OUT)"></div>
        </div>

        <textarea id="workDetails" class="form-control mb-2" rows="2" placeholder="Kaam ki details..."></textarea>

        <div class="mb-2">
            <strong>Photo:</strong>
            <input type="file" id="photoInput" class="form-control" accept="image/*" onchange="previewImage()">
            <img id="imgPreview" class="img-preview" src="">
        </div>

        <button class="btn btn-green-block" onclick="saveWork()">Save Record</button>
    </div>

    <div class="card-box">
        <div class="section-title title-orange">2. Payment Entry (Cash)</div>
        
        <select id="paymentWorkerSelect" class="form-select mb-2">
            <option value="">Select Worker...</option>
        </select>

        <div class="row g-2 mb-2">
            <div class="col-6"><input type="date" id="payDate" class="form-control"></div>
            <div class="col-6"><input type="number" id="payAmount" class="form-control" placeholder="Amount ₹"></div>
        </div>

        <button class="btn btn-orange-block" onclick="savePayment()">Save Payment</button>
    </div>

    <div class="card-box">
        <div class="section-title title-purple">3. Generate Hisab</div>
        
        <select id="billWorkerSelect" class="form-select mb-2">
            <option value="">Select Worker...</option>
        </select>

        <button class="btn btn-purple-block" onclick="generateBill()">Generate Bill</button>
    </div>

    <div class="card-box">
        <div class="section-title">Saved Records</div>
        <div class="table-responsive">
            <table class="table table-bordered table-custom">
                <thead>
                    <tr>
                        <th>Date/Site</th>
                        <th>Detail</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-red-block mt-3" onclick="resetAllData()">RESET ALL DATA (Format)</button>
    </div>
</div>

<div class="modal fade" id="workerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Worker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="newWorkerName" class="form-control mb-2" placeholder="Name">
                <input type="number" id="newWorkerRate" class="form-control mb-2" placeholder="Rate (Per Day) ₹">
                <select id="newWorkerType" class="form-select mb-2">
                    <option value="Mistri">Mistri</option>
                    <option value="Helper">Helper</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addWorker()">Add Worker</button>
            </div>
        </div>
    </div>
</div>

<div id="billModal">
    <div class="bill-paper" id="billContent">
        <h4 class="text-center text-uppercase fw-bold mb-2">Shree Vaibhav Laxmi Ent.</h4>
        <div class="text-center mb-3" id="billStatementTitle">Statement: Name</div>
        <hr>
        
        <div class="d-flex justify-content-between mb-2">
            <strong>Total Days:</strong>
            <span id="billTotalDays">0</span>
        </div>

        <div class="d-flex justify-content-between mb-2 text-success">
            <strong>Total Kamayi:</strong>
            <span id="billTotalKamayi">₹0</span>
        </div>

        <div class="d-flex justify-content-between mb-2 text-danger">
            <strong>(-) Daily Advance:</strong>
            <span id="billDailyAdvance">₹0</span>
        </div>

        <div class="d-flex justify-content-between mb-2 text-danger">
            <strong>(-) Cash Given:</strong>
            <span id="billCashGiven">₹0</span>
        </div>

        <hr>
        <div class="text-center">
            <h4 class="text-danger fw-bold" id="billBalance">BAKI (Balance): ₹0</h4>
        </div>
        
        <div class="mt-3">
             <small class="text-muted">Work Details:</small>
             <table class="table table-sm table-bordered" style="font-size: 12px;">
                 <tbody id="billDetailTable"></tbody>
             </table>
        </div>

        <div class="mt-4 gap-2 d-flex no-print">
            <button class="btn btn-primary flex-grow-1" onclick="window.print()">Print</button>
            <button class="btn btn-danger flex-grow-1" onclick="closeBill()">Close</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Data Management ---
    let workers = JSON.parse(localStorage.getItem('svl_workers')) || [];
    let records = JSON.parse(localStorage.getItem('svl_records')) || [];

    // --- Init ---
    window.onload = function() {
        document.getElementById('workDate').valueAsDate = new Date();
        document.getElementById('payDate').valueAsDate = new Date();
        renderUI();
    };

    // --- Worker Functions ---
    const workerModal = new bootstrap.Modal(document.getElementById('workerModal'));

    function openWorkerModal() {
        workerModal.show();
    }

    function addWorker() {
        const name = document.getElementById('newWorkerName').value;
        const rate = document.getElementById('newWorkerRate').value;
        const type = document.getElementById('newWorkerType').value;

        if(name && rate) {
            workers.push({
                id: Date.now(),
                name: name,
                rate: parseFloat(rate),
                type: type
            });
            localStorage.setItem('svl_workers', JSON.stringify(workers));
            workerModal.hide();
            
            // Clear inputs
            document.getElementById('newWorkerName').value = '';
            document.getElementById('newWorkerRate').value = '';
            
            renderUI();
        } else {
            alert("Name and Rate are required.");
        }
    }

    function renderUI() {
        // 1. Worker List Text
        const label = document.getElementById('workerListLabel');
        label.innerText = workers.length ? 
            "Workers: " + workers.map(w => `${w.name} (${w.type})`).join(", ") : 
            "No workers.";

        // 2. Hajari Checkboxes
        const checklist = document.getElementById('workerCheckboxes');
        checklist.innerHTML = "";
        workers.forEach(w => {
            checklist.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input worker-check" type="checkbox" value="${w.id}" id="chk_${w.id}">
                    <label class="form-check-label" for="chk_${w.id}">${w.name} - ₹${w.rate}</label>
                </div>
            `;
        });

        // 3. Dropdowns
        const paySelect = document.getElementById('paymentWorkerSelect');
        const billSelect = document.getElementById('billWorkerSelect');
        
        let optionsHtml = '<option value="">Select Worker...</option>';
        workers.forEach(w => {
            optionsHtml += `<option value="${w.id}">${w.name}</option>`;
        });
        
        paySelect.innerHTML = optionsHtml;
        billSelect.innerHTML = optionsHtml;

        // 4. Records Table
        renderRecordsTable();
    }

    // --- Image Handling ---
    let currentImgBase64 = null;
    function previewImage() {
        const file = document.getElementById('photoInput').files[0];
        const preview = document.getElementById('imgPreview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImgBase64 = e.target.result;
                preview.src = currentImgBase64;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        } else {
            currentImgBase64 = null;
            preview.style.display = 'none';
        }
    }

    // --- Save Functions ---
    function saveWork() {
        const date = document.getElementById('workDate').value;
        const site = document.getElementById('siteName').value;
        const checkboxes = document.querySelectorAll('.worker-check:checked');
        const dailyExp = parseFloat(document.getElementById('dailyExpense').value) || 0;
        const inQty = document.getElementById('maalIn').value;
        const outQty = document.getElementById('maalOut').value;
        const details = document.getElementById('workDetails').value;

        if (checkboxes.length === 0 && !site) {
            alert("Please select workers or enter site.");
            return;
        }

        const selectedWorkers = [];
        checkboxes.forEach(cb => {
            const w = workers.find(work => work.id == cb.value);
            if(w) selectedWorkers.push(w);
        });

        // Split daily expense among present workers or store as total
        // For simplicity, we store the total daily expense for this record
        // In bill, we will assign this expense to the worker if they were present

        const record = {
            id: Date.now(),
            type: 'WORK',
            date: date,
            site: site,
            workersObj: selectedWorkers, // Stores name and rate at time of work
            expense: dailyExp, // "Daily Advance" from screenshot 4
            in: inQty,
            out: outQty,
            details: details,
            img: currentImgBase64
        };

        records.push(record);
        localStorage.setItem('svl_records', JSON.stringify(records));
        
        // Reset
        document.getElementById('siteName').value = "";
        document.getElementById('dailyExpense').value = "";
        document.getElementById('maalIn').value = "";
        document.getElementById('maalOut').value = "";
        document.getElementById('workDetails').value = "";
        document.getElementById('photoInput').value = "";
        document.getElementById('imgPreview').style.display = "none";
        document.querySelectorAll('.worker-check').forEach(c => c.checked = false);
        currentImgBase64 = null;
        
        alert("Work Record Saved!");
        renderRecordsTable();
    }

    function savePayment() {
        const workerId = document.getElementById('paymentWorkerSelect').value;
        const amount = document.getElementById('payAmount').value;
        const date = document.getElementById('payDate').value;

        if(!workerId || !amount) {
            alert("Select worker and amount.");
            return;
        }

        const worker = workers.find(w => w.id == workerId);

        const record = {
            id: Date.now(),
            type: 'PAYMENT',
            date: date,
            workerId: workerId,
            workerName: worker.name,
            amount: parseFloat(amount)
        };

        records.push(record);
        localStorage.setItem('svl_records', JSON.stringify(records));

        document.getElementById('payAmount').value = "";
        alert("Payment Saved!");
        renderRecordsTable();
    }

    // --- Table Render ---
    function renderRecordsTable() {
        const tbody = document.getElementById('recordsTableBody');
        tbody.innerHTML = "";

        // Show newest first
        const sorted = [...records].reverse();

        sorted.forEach(rec => {
            let row = "";
            if(rec.type === 'WORK') {
                const names = rec.workersObj.map(w => w.name).join(", ");
                const imgTag = rec.img ? `<img src="${rec.img}">` : '';
                row = `
                    <tr>
                        <td>
                            <b>${rec.date}</b><br>
                            ${rec.site}<br>
                        </td>
                        <td>
                            <span class="text-primary">Workers: ${names}</span><br>
                            ${rec.details}<br>
                            <small>IN: ${rec.in} | OUT: ${rec.out}</small>
                            ${imgTag}
                        </td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="deleteRecord(${rec.id})">X</button></td>
                    </tr>
                `;
            } else {
                row = `
                    <tr class="table-warning">
                        <td><b>${rec.date}</b><br>Payment</td>
                        <td>
                            Paid to: <b>${rec.workerName}</b><br>
                            Amount: ₹${rec.amount}
                        </td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="deleteRecord(${rec.id})">X</button></td>
                    </tr>
                `;
            }
            tbody.innerHTML += row;
        });
    }

    function deleteRecord(id) {
        if(confirm("Delete this record?")) {
            records = records.filter(r => r.id !== id);
            localStorage.setItem('svl_records', JSON.stringify(records));
            renderRecordsTable();
        }
    }

    // --- Generate Hisab (The Core Logic) ---
    function generateBill() {
        const workerId = document.getElementById('billWorkerSelect').value;
        if(!workerId) {
            alert("Select a worker first.");
            return;
        }

        const worker = workers.find(w => w.id == workerId);
        
        // Calculations
        let totalDays = 0;
        let totalKamayi = 0;
        let totalAdvance = 0; // The "Daily Advance" from Screenshot 4
        let totalCash = 0;    // The Payment Entry
        let detailRows = "";

        records.forEach(rec => {
            if(rec.type === 'WORK') {
                // Check if this worker was present in this record
                const present = rec.workersObj.find(w => w.id == workerId);
                if(present) {
                    totalDays++;
                    // Use the rate saved at that time, or current rate if legacy
                    const rate = present.rate || worker.rate; 
                    totalKamayi += rate;
                    
                    // Logic for Daily Expense/Advance
                    // If expense was recorded, split it or assign it? 
                    // Screenshot says "Daily Advance: 20". Let's assume if expense exists, it applies.
                    // If multiple workers, we split? Or full? 
                    // Simple approach: If expense > 0, we count it.
                    if(rec.expense > 0) {
                        // Split cost among workers present? 
                        const splitCost = rec.expense / rec.workersObj.length;
                        totalAdvance += splitCost;
                    }

                    detailRows += `
                        <tr>
                            <td>${rec.date}</td>
                            <td>Work (${rec.site})</td>
                            <td class="text-end text-success">+${rate}</td>
                        </tr>
                    `;
                }
            } else if (rec.type === 'PAYMENT' && rec.workerId == workerId) {
                totalCash += rec.amount;
                detailRows += `
                    <tr>
                        <td>${rec.date}</td>
                        <td>Cash Given</td>
                        <td class="text-end text-danger">-${rec.amount}</td>
                    </tr>
                `;
            }
        });

        // Round off Advance
        totalAdvance = Math.round(totalAdvance);
        const balance = totalKamayi - totalAdvance - totalCash;

        // Update DOM
        document.getElementById('billStatementTitle').innerText = `Statement: ${worker.name} (${worker.type})`;
        document.getElementById('billTotalDays').innerText = totalDays;
        document.getElementById('billTotalKamayi').innerText = `₹${totalKamayi}`;
        document.getElementById('billDailyAdvance').innerText = `₹${totalAdvance}`;
        document.getElementById('billCashGiven').innerText = `₹${totalCash}`;
        document.getElementById('billBalance').innerText = `BAKI (Balance): ₹${balance}`;
        document.getElementById('billDetailTable').innerHTML = detailRows;

        // Show Modal
        document.getElementById('billModal').style.display = 'flex';
    }

    function closeBill() {
        document.getElementById('billModal').style.display = 'none';
    }

    function resetAllData() {
        if(confirm("DANGER: This will delete ALL data permanently. Continue?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>
