<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Fixed Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .app-header {
            background-color: black;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            display: flex;
            align-items: center;
        }
        .header-title {
            text-align: center;
            color: #dc3545; /* Red color from screenshot */
            font-weight: bold;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        /* Section Headings */
        .section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .text-green { color: #198754; }
        .text-orange { color: #fd7e14; }
        .text-purple { color: #6f42c1; }

        /* Custom Cards */
        .custom-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn-add-worker { background-color: #0d6efd; color: white; width: 100%; font-weight: bold; }
        .btn-save-record { background-color: #198754; color: white; width: 100%; font-weight: bold; }
        .btn-save-payment { background-color: #fd7e14; color: white; width: 100%; font-weight: bold; }
        .btn-generate { background-color: #6f42c1; color: white; width: 100%; font-weight: bold; }
        .btn-reset { background-color: #dc3545; color: white; width: 100%; font-weight: bold; }

        .hajari-box {
            background-color: #e9ecef; /* Light blue/grey from screenshot */
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #0d6efd;
        }

        .img-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 5px;
            display: none;
            border: 1px solid #ccc;
        }

        /* Table Styling */
        .table-responsive {
            font-size: 14px;
        }
        .table img {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }

        /* Print/PDF Styling */
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="app-header">
        <span>⬅ Shree Vaibhav Laxmi Fixed Tracker</span>
    </div>

    <div class="header-title">Shree Vaibhav Laxmi Ent.</div>

    <button class="btn btn-add-worker mb-2" onclick="promptAddWorker()">+ Worker Add Karein</button>
    <div id="workerListDisplay" class="mb-3 text-muted small">No workers.</div>

    <div class="custom-card">
        <div class="section-title text-green">1. Daily Work Entry</div>
        
        <select class="form-select mb-2">
            <option>Select Site (Optional)</option>
        </select>

        <input type="text" id="siteName" class="form-control mb-2" placeholder="Site Name">

        <div class="hajari-box">
            <strong>Worker Hajari:</strong>
            <div id="hajariCheckboxes">
                <span class="text-muted">Add workers first.</span>
            </div>
        </div>

        <div class="row g-2 mb-2">
            <div class="col-6">
                <input type="number" id="maalIn" class="form-control" placeholder="Maal Aaya (IN)">
            </div>
            <div class="col-6">
                <input type="number" id="maalOut" class="form-control" placeholder="Maal Laga (OUT)">
            </div>
        </div>

        <textarea id="workDetails" class="form-control mb-2" rows="2" placeholder="Kaam ki details..."></textarea>

        <div class="mb-2">
            <strong>Photo:</strong>
            <input type="file" id="photoInput" class="form-control" accept="image/*" onchange="previewImage()">
            <img id="previewImg" class="img-preview" src="" alt="Preview">
        </div>

        <button class="btn btn-save-record" onclick="saveWorkRecord()">Save Record</button>
    </div>

    <div class="custom-card">
        <div class="section-title text-orange">2. Payment Entry (Cash)</div>
        
        <select id="paymentWorkerSelect" class="form-select mb-2">
            <option value="">Select Worker...</option>
        </select>

        <div class="row g-2 mb-2">
            <div class="col-6">
                <input type="date" id="paymentDate" class="form-control">
            </div>
            <div class="col-6">
                <input type="number" id="paymentAmount" class="form-control" placeholder="Amount ₹">
            </div>
        </div>

        <button class="btn btn-save-payment" onclick="savePayment()">Save Payment</button>
    </div>

    <div class="custom-card">
        <div class="section-title text-purple">3. Generate Hisab</div>
        
        <select id="billWorkerSelect" class="form-select mb-2">
            <option value="">Select Worker...</option>
            <option value="ALL">ALL WORKERS</option>
        </select>

        <button class="btn btn-generate" onclick="generateBill()">Generate Bill</button>
    </div>

    <div class="custom-card">
        <div class="section-title">Saved Records</div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="recordsTable">
                <thead class="table-light">
                    <tr>
                        <th>Date/Site</th>
                        <th>Detail</th>
                        <th>Image</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                    </tbody>
            </table>
        </div>
        
        <button class="btn btn-reset mt-3" onclick="resetAllData()">RESET ALL DATA (Format)</button>
    </div>
</div>

<div id="printableArea" style="display:none; padding: 20px; background: white;">
    <h2 style="text-align: center; color: #dc3545;">Shree Vaibhav Laxmi Ent.</h2>
    <h4 style="text-align: center;">Worker Hisab / Bill</h4>
    <hr>
    <div id="billContent"></div>
    <div style="margin-top: 30px; text-align: center;">
        <button class="btn btn-primary no-print" onclick="window.print()">Print / Save PDF</button>
        <button class="btn btn-secondary no-print" onclick="closeBill()">Close</button>
    </div>
</div>

<script>
    // --- State Management ---
    let workers = JSON.parse(localStorage.getItem('svl_workers')) || [];
    let records = JSON.parse(localStorage.getItem('svl_records')) || [];
    let payments = JSON.parse(localStorage.getItem('svl_payments')) || [];

    // --- Initialization ---
    window.onload = function() {
        document.getElementById('paymentDate').valueAsDate = new Date();
        renderWorkers();
        renderRecordsTable();
    };

    // --- 1. Worker Functions ---
    function promptAddWorker() {
        let name = prompt("Enter Worker Name:");
        if (name && name.trim() !== "") {
            workers.push(name.trim());
            localStorage.setItem('svl_workers', JSON.stringify(workers));
            renderWorkers();
        }
    }

    function renderWorkers() {
        const listDisplay = document.getElementById('workerListDisplay');
        const hajariDiv = document.getElementById('hajariCheckboxes');
        const paySelect = document.getElementById('paymentWorkerSelect');
        const billSelect = document.getElementById('billWorkerSelect');

        // Update list text
        if (workers.length === 0) {
            listDisplay.innerText = "No workers.";
            hajariDiv.innerHTML = '<span class="text-muted">Add workers first.</span>';
        } else {
            listDisplay.innerText = "Workers: " + workers.join(", ");
            
            // Update Hajari Checkboxes
            hajariDiv.innerHTML = "";
            workers.forEach((worker, index) => {
                hajariDiv.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input worker-check" type="checkbox" value="${worker}" id="w_${index}">
                        <label class="form-check-label" for="w_${index}">${worker}</label>
                    </div>
                `;
            });
        }

        // Update Dropdowns
        paySelect.innerHTML = '<option value="">Select Worker...</option>';
        billSelect.innerHTML = '<option value="">Select Worker...</option><option value="ALL">ALL WORKERS</option>';
        
        workers.forEach(worker => {
            paySelect.innerHTML += `<option value="${worker}">${worker}</option>`;
            billSelect.innerHTML += `<option value="${worker}">${worker}</option>`;
        });
    }

    // --- 2. Image Handling ---
    let currentImageBase64 = "";

    function previewImage() {
        const file = document.getElementById('photoInput').files[0];
        const preview = document.getElementById('previewImg');
        const reader = new FileReader();

        reader.onloadend = function() {
            preview.src = reader.result;
            preview.style.display = "block";
            currentImageBase64 = reader.result;
        }

        if (file) {
            reader.readAsDataURL(file);
        } else {
            preview.src = "";
            preview.style.display = "none";
            currentImageBase64 = "";
        }
    }

    // --- 3. Save Work Record ---
    function saveWorkRecord() {
        const site = document.getElementById('siteName').value;
        const checks = document.querySelectorAll('.worker-check:checked');
        const presentWorkers = Array.from(checks).map(c => c.value);
        const inQty = document.getElementById('maalIn').value;
        const outQty = document.getElementById('maalOut').value;
        const details = document.getElementById('workDetails').value;

        if (!site && presentWorkers.length === 0 && !details) {
            alert("Please fill at least Site Name, Worker or Details.");
            return;
        }

        const record = {
            id: Date.now(),
            type: 'WORK',
            date: new Date().toLocaleDateString(),
            timestamp: new Date().toLocaleString(),
            site: site,
            workers: presentWorkers,
            in: inQty,
            out: outQty,
            details: details,
            image: currentImageBase64
        };

        records.push(record);
        localStorage.setItem('svl_records', JSON.stringify(records));
        
        // Reset Form
        document.getElementById('siteName').value = "";
        document.getElementById('maalIn').value = "";
        document.getElementById('maalOut').value = "";
        document.getElementById('workDetails').value = "";
        document.getElementById('photoInput').value = "";
        document.getElementById('previewImg').style.display = "none";
        currentImageBase64 = "";
        document.querySelectorAll('.worker-check').forEach(c => c.checked = false);

        renderRecordsTable();
        alert("Record Saved Successfully!");
    }

    // --- 4. Save Payment ---
    function savePayment() {
        const worker = document.getElementById('paymentWorkerSelect').value;
        const date = document.getElementById('paymentDate').value;
        const amount = document.getElementById('paymentAmount').value;

        if (!worker || !amount) {
            alert("Select Worker and enter Amount.");
            return;
        }

        const payment = {
            id: Date.now(),
            type: 'PAYMENT',
            date: date,
            worker: worker,
            amount: amount
        };

        records.push(payment); // Storing in same array for easier list logic, but type distinguishes it
        localStorage.setItem('svl_records', JSON.stringify(records));

        document.getElementById('paymentAmount').value = "";
        renderRecordsTable();
        alert("Payment Saved!");
    }

    // --- 5. Render Table ---
    function renderRecordsTable() {
        const tbody = document.getElementById('recordsBody');
        tbody.innerHTML = "";

        // Sort by newest first
        const sortedRecords = records.slice().reverse();

        sortedRecords.forEach(rec => {
            let rowHtml = "";
            if (rec.type === 'WORK') {
                let workerStr = rec.workers.length > 0 ? `<br><small class="text-primary">Workers: ${rec.workers.join(', ')}</small>` : '';
                let matStr = (rec.in || rec.out) ? `<br><small>IN: ${rec.in} | OUT: ${rec.out}</small>` : '';
                let imgStr = rec.image ? `<img src="${rec.image}" onclick="viewImage('${rec.image}')">` : '-';

                rowHtml = `
                    <tr>
                        <td><b>${rec.date}</b><br>${rec.site}</td>
                        <td>${rec.details || 'No Details'} ${workerStr} ${matStr}</td>
                        <td>${imgStr}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRecord(${rec.id})">X</button></td>
                    </tr>
                `;
            } else if (rec.type === 'PAYMENT') {
                rowHtml = `
                    <tr class="table-warning">
                        <td><b>${rec.date}</b><br>Payment</td>
                        <td>Paid to: <b>${rec.worker}</b><br>Amount: ₹${rec.amount}</td>
                        <td>-</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRecord(${rec.id})">X</button></td>
                    </tr>
                `;
            }
            tbody.innerHTML += rowHtml;
        });
    }

    function deleteRecord(id) {
        if(confirm("Delete this record?")) {
            records = records.filter(r => r.id !== id);
            localStorage.setItem('svl_records', JSON.stringify(records));
            renderRecordsTable();
        }
    }

    function viewImage(src) {
        let w = window.open("");
        w.document.write(`<img src="${src}" style="width:100%">`);
    }

    // --- 6. Generate Bill / PDF ---
    function generateBill() {
        const worker = document.getElementById('billWorkerSelect').value;
        if (!worker) {
            alert("Please select a worker or ALL.");
            return;
        }

        const printDiv = document.getElementById('printableArea');
        const contentDiv = document.getElementById('billContent');
        const mainDiv = document.querySelector('.main-container');

        let html = '<table style="width:100%; border-collapse: collapse; border: 1px solid black;">';
        html += '<tr style="background:#ddd;"><th>Date</th><th>Description</th><th>Site</th><th>Image</th><th>Amount/Note</th></tr>';

        let totalPayment = 0;

        records.forEach(rec => {
            if (rec.type === 'PAYMENT') {
                if (worker === 'ALL' || rec.worker === worker) {
                    html += `
                        <tr>
                            <td style="border:1px solid black; padding:5px;">${rec.date}</td>
                            <td style="border:1px solid black; padding:5px;">Payment to ${rec.worker}</td>
                            <td style="border:1px solid black; padding:5px;">-</td>
                            <td style="border:1px solid black; padding:5px;">-</td>
                            <td style="border:1px solid black; padding:5px; color:red;">- ₹${rec.amount}</td>
                        </tr>
                    `;
                    totalPayment += parseFloat(rec.amount);
                }
            } else if (rec.type === 'WORK') {
                // If filtering by worker, check if worker is in the list
                if (worker === 'ALL' || rec.workers.includes(worker)) {
                    let imgTag = rec.image ? `<img src="${rec.image}" style="width:80px;">` : '';
                    html += `
                        <tr>
                            <td style="border:1px solid black; padding:5px;">${rec.date}</td>
                            <td style="border:1px solid black; padding:5px;">${rec.details} <br> <small>IN:${rec.in} OUT:${rec.out}</small></td>
                            <td style="border:1px solid black; padding:5px;">${rec.site}</td>
                            <td style="border:1px solid black; padding:5px;">${imgTag}</td>
                            <td style="border:1px solid black; padding:5px;">Work Done</td>
                        </tr>
                    `;
                }
            }
        });

        html += `</table>`;
        
        if (worker !== 'ALL') {
             html += `<h3 style="text-align:right; margin-top:20px;">Total Paid to ${worker}: ₹${totalPayment}</h3>`;
        }

        contentDiv.innerHTML = html;
        
        // Show Print View
        mainDiv.style.display = 'none';
        printDiv.style.display = 'block';
    }

    function closeBill() {
        document.getElementById('printableArea').style.display = 'none';
        document.querySelector('.main-container').style.display = 'block';
    }

    function resetAllData() {
        if(confirm("WARNING: This will delete ALL workers and records permanently. Continue?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>
