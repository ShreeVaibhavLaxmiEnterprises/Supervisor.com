<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Enterprises Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #d32f2f; --secondary: #1976d2; --success: #388e3c; --bg: #f3f4f6; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; margin: 0; }
        
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-top: 0; }
        .subtitle { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;}

        /* SECTIONS */
        .box { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; background: #fff; }
        .box h4 { margin: 0 0 10px 0; background: #eee; padding: 5px; border-left: 4px solid var(--secondary); }

        /* INPUTS */
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* BUTTONS */
        button { width: 100%; padding: 12px; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 5px; }
        .btn-blue { background: var(--secondary); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--primary); width: auto; padding: 5px 10px; font-size: 12px; }
        .btn-orange { background: #ff9800; color: #000; font-weight: bold; }

        /* LISTS & TABLES */
        ul { padding-left: 20px; }
        li { margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #e3f2fd; }

        /* SPECIAL */
        .hajari-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 5px 0; }
        .hajari-input { width: 60px !important; text-align: center; margin: 0; border: 2px solid #90caf9; }
        #calculatorResult { display: none; background: #e8f5e9; border: 1px solid #c8e6c9; padding: 10px; margin-top: 10px; }

        /* PDF TEMPLATE (Off Screen) */
        #pdfTemplate { position: absolute; left: -9999px; top: 0; width: 700px; padding: 20px; background: white; border: 2px solid black; color: black; font-family: 'Helvetica', sans-serif; }
        .bill-head { text-align: center; border-bottom: 2px solid black; margin-bottom: 20px; }
        .bill-tbl { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .bill-tbl th, .bill-tbl td { border: 1px solid black; padding: 10px; }

        @media print { .no-print { display: none !important; } .container { box-shadow: none; } }
    </style>
</head>
<body>

<div class="container">
    <h2>Shree Vaibhav Laxmi Enterprises</h2>
    <p class="subtitle">Supervisor: Siddharth Yadav | Tracking App</p>

    <div class="box no-print">
        <button class="btn-blue" onclick="document.getElementById('workerForm').style.display='block'">+ Worker Add Karein</button>
        <div id="workerForm" style="display:none; margin-top:10px;">
            <input type="text" id="wName" placeholder="Name (Eg. Raju)">
            <select id="wType"><option>Mistri</option><option>Helper</option></select>
            <input type="number" id="wRate" placeholder="Rate (Eg. 500)">
            <button class="btn-green" onclick="addWorker()">Save Worker</button>
            <ul id="workerList"></ul>
        </div>
    </div>

    <div class="box no-print">
        <h4>Daily Entry (रोज़ का काम)</h4>
        <label>Date:</label>
        <input type="date" id="dDate">
        <input type="text" id="dSite" placeholder="Site Name">
        
        <div style="background:#f9f9f9; padding:5px; border:1px solid #eee; margin-bottom:10px;">
            <strong>Worker Hajari:</strong>
            <div id="attendanceArea"></div>
        </div>

        <textarea id="matIn" placeholder="Maal Aaya (IN)..." rows="2"></textarea>
        <textarea id="matOut" placeholder="Maal Laga (OUT)..." rows="2"></textarea>
        <textarea id="workDesc" placeholder="Aaj ka kaam..." rows="2"></textarea>
        
        <input type="file" id="imgInput" accept="image/*" onchange="previewImg(this)">
        <img id="imgView" style="max-height:80px; display:none;">
        <input type="hidden" id="imgBase64">

        <button class="btn-green" onclick="saveData()">Save Daily Record</button>
    </div>

    <div class="box no-print">
        <h4>Hisab Kitab (Calculator)</h4>
        <div style="display:flex; gap:5px;">
            <input type="date" id="cFrom">
            <input type="date" id="cTo">
        </div>
        <select id="cWorker"><option value="">Worker Select...</option></select>
        <button class="btn-blue" onclick="calculate()">Check Hisab</button>

        <div id="calculatorResult">
            <h3><span id="resName"></span> Ka Hisab</h3>
            <p id="resRange"></p>
            <p>Total Days: <b id="resDays">0</b></p>
            <p>Total Hajari: <b id="resHajari">0</b></p>
            <p>Total Paisa: <b style="color:green; font-size:1.2rem;">₹<span id="resMoney">0</span></b></p>
            <button class="btn-orange" onclick="downloadPDF()">Download Bill PDF</button>
        </div>
    </div>

    <div class="box">
        <h4>Saved Records <button onclick="window.print()" style="width:auto; float:right; padding:5px; margin:0; font-size:12px;">Print Page</button></h4>
        <div style="overflow-x:auto;">
            <table id="dataTable">
                <thead><tr><th>Date/Site</th><th>Details</th><th>Payment</th><th class="no-print">Del</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="pdfTemplate">
    <div class="bill-head">
        <h1 style="margin:0; color:#d32f2f;">SHREE VAIBHAV LAXMI ENTERPRISES</h1>
        <p>Supervisor: Siddharth Yadav | PAYMENT SLIP</p>
        <p>Date: <span id="pdfDate"></span></p>
    </div>
    <div style="display:flex; justify-content:space-between;">
        <div><strong>Worker:</strong> <span id="pdfName"></span></div>
        <div><strong>Ref:</strong> <span id="pdfRef"></span></div>
    </div>
    <table class="bill-tbl">
        <thead><tr style="background:#eee;"><th>Description</th><th style="text-align:right;">Amount</th></tr></thead>
        <tbody>
            <tr><td>Total Hajari (Attendance)</td><td style="text-align:right;" id="pdfHajari"></td></tr>
            <tr><td>Rate Per Day</td><td style="text-align:right;" id="pdfRate"></td></tr>
            <tr><td><strong>TOTAL PAYABLE</strong></td><td style="text-align:right; font-weight:bold; font-size:1.2rem;" id="pdfTotal"></td></tr>
        </tbody>
    </table>
    <br><br><br>
    <div style="display:flex; justify-content:space-between; margin-top:50px;">
        <div style="border-top:1px solid black; width:150px; text-align:center;">Worker Sign</div>
        <div style="border-top:1px solid black; width:150px; text-align:center;">Supervisor Sign</div>
    </div>
</div>

<script>
    // --- 1. SETUP & HELPERS ---
    // App load hone par ye chalega
    window.onload = function() {
        document.getElementById('dDate').valueAsDate = new Date();
        loadAll();
    };

    function getStore(key) { return JSON.parse(localStorage.getItem(key)) || []; }
    function setStore(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    // --- 2. WORKER LOGIC ---
    function addWorker() {
        let n = document.getElementById('wName').value;
        let t = document.getElementById('wType').value;
        let r = document.getElementById('wRate').value;
        if(!n) return alert("Naam likho!");

        let workers = getStore('svle_workers');
        workers.push({ id: Date.now(), name: n, type: t, rate: r });
        setStore('svle_workers', workers);
        
        document.getElementById('wName').value = '';
        loadAll();
        alert("Worker Added!");
    }

    function deleteWorker(id) {
        if(confirm("Delete?")) {
            let w = getStore('svle_workers').filter(x => x.id !== id);
            setStore('svle_workers', w);
            loadAll();
        }
    }

    // --- 3. DISPLAY LOGIC ---
    function loadAll() {
        let workers = getStore('svle_workers');
        
        // Update Worker List UL
        let ul = document.getElementById('workerList');
        ul.innerHTML = '';
        workers.forEach(w => {
            ul.innerHTML += `<li>${w.name} (${w.rate}) <button class="btn-red" onclick="deleteWorker(${w.id})">X</button></li>`;
        });

        // Update Attendance Form
        let attDiv = document.getElementById('attendanceArea');
        attDiv.innerHTML = '';
        if(workers.length === 0) attDiv.innerHTML = 'No workers.';
        workers.forEach(w => {
            attDiv.innerHTML += `
                <div class="hajari-row">
                    <span>${w.name} <small>(${w.rate})</small></span>
                    <input type="number" step="0.5" id="h_${w.id}" class="hajari-input" placeholder="0">
                </div>`;
        });

        // Update Dropdown
        let sel = document.getElementById('cWorker');
        sel.innerHTML = '<option value="">Select Worker...</option>';
        workers.forEach(w => sel.innerHTML += `<option value="${w.name}">${w.name}</option>`);

        // Load Table
        loadTable();
    }

    // --- 4. SAVE DAILY DATA ---
    function previewImg(input) {
        if(input.files && input.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imgView').src = e.target.result;
                document.getElementById('imgView').style.display = 'block';
                document.getElementById('imgBase64').value = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveData() {
        let date = document.getElementById('dDate').value;
        let site = document.getElementById('dSite').value;
        if(!date || !site) return alert("Date aur Site Name likho!");

        let workers = getStore('svle_workers');
        let hajariList = [];
        let totalPay = 0;

        workers.forEach(w => {
            let inp = document.getElementById('h_' + w.id);
            if(inp && inp.value > 0) {
                let pay = parseFloat(inp.value) * parseFloat(w.rate);
                hajariList.push({ name: w.name, val: inp.value, pay: pay, rate: w.rate });
                totalPay += pay;
            }
        });

        let record = {
            id: Date.now(), date, site,
            matIn: document.getElementById('matIn').value,
            matOut: document.getElementById('matOut').value,
            workDesc: document.getElementById('workDesc').value,
            img: document.getElementById('imgBase64').value,
            list: hajariList,
            total: totalPay
        };

        let records = getStore('svle_records');
        records.push(record);
        setStore('svle_records', records);
        
        alert("Saved!");
        location.reload(); // Refresh to clear form cleanly
    }

    // --- 5. TABLE LOGIC ---
    function loadTable() {
        let records = getStore('svle_records');
        records.sort((a,b) => new Date(b.date) - new Date(a.date)); // Newest first
        
        let tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        records.forEach(r => {
            let workerTxt = r.list.map(x => `${x.name}: ${x.val}`).join('<br>');
            let row = `
                <tr>
                    <td><b>${r.date}</b><br>${r.site}</td>
                    <td>
                        ${r.workDesc ? 'Work: '+r.workDesc+'<br>':''}
                        ${r.matIn ? '<span style="color:green">IN: '+r.matIn+'</span><br>':''}
                        ${r.matOut ? '<span style="color:red">OUT: '+r.matOut+'</span>':''}
                    </td>
                    <td>${workerTxt}<br><b>Total: ₹${r.total}</b></td>
                    <td class="no-print"><button class="btn-red" onclick="delRecord(${r.id})">X</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function delRecord(id) {
        if(confirm("Delete Record?")) {
            let r = getStore('svle_records').filter(x => x.id !== id);
            setStore('svle_records', r);
            loadTable();
        }
    }

    // --- 6. CALCULATOR & PDF ---
    function calculate() {
        let name = document.getElementById('cWorker').value;
        let d1 = document.getElementById('cFrom').value;
        let d2 = document.getElementById('cTo').value;
        if(!name) return alert("Worker Select Karo!");

        let records = getStore('svle_records');
        let days=0, hajari=0, money=0, lastRate=0;

        records.forEach(r => {
            if(d1 && r.date < d1) return;
            if(d2 && r.date > d2) return;

            let entry = r.list.find(x => x.name === name);
            if(entry) {
                days++;
                hajari += parseFloat(entry.val);
                money += parseFloat(entry.pay);
                lastRate = entry.rate; // Keep last known rate for PDF
            }
        });

        document.getElementById('resName').innerText = name;
        document.getElementById('resRange').innerText = (d1 && d2) ? `${d1} se ${d2}` : "Full Record";
        document.getElementById('resDays').innerText = days;
        document.getElementById('resHajari').innerText = hajari;
        document.getElementById('resMoney').innerText = money;
        document.getElementById('calculatorResult').style.display = 'block';

        // Fill PDF Data
        document.getElementById('pdfName').innerText = name;
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
        document.getElementById('pdfRef').innerText = "SVL-"+Math.floor(Math.random()*1000);
        document.getElementById('pdfHajari').innerText = hajari;
        document.getElementById('pdfRate').innerText = "₹" + lastRate;
        document.getElementById('pdfTotal').innerText = "₹" + money;
    }

    function downloadPDF() {
        let el = document.getElementById('pdfTemplate');
        let name = document.getElementById('pdfName').innerText;
        
        let opt = {
            margin: 0.5,
            filename: name + '_Bill.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        
        try {
            html2pdf().set(opt).from(el).save();
        } catch(e) {
            alert("Internet ON karo PDF ke liye!");
        }
    }
</script>

</body>
</html>
