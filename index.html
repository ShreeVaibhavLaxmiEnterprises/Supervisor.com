<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Enterprises Tracker Pro</title>
    <style>
        :root {
            --primary: #d32f2f;
            --blue-btn: #1976d2;
            --green-btn: #388e3c;
            --purple-btn: #7b1fa2;
            --bg: #f5f5f5;
            --border: #ddd;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* Main Container */
        .app-container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Headers */
        .main-header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .main-header h2 { color: var(--primary); margin: 0; text-transform: uppercase; font-weight: 800; font-size: 1.4rem; }
        .main-header p { color: #555; margin: 5px 0 0; font-size: 0.9rem; font-weight: 600; }

        /* Section Boxes */
        .section-box { background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section-title { font-weight: bold; border-left: 4px solid var(--blue-btn); padding-left: 8px; margin-bottom: 15px; background: #e3f2fd; padding: 5px 8px; }
        .hisab-title { border-left-color: var(--purple-btn); background: #f3e5f5; }

        /* Forms */
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-top: 10px; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; background: #fff; }
        
        /* Buttons */
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-blue { background: var(--blue-btn); }
        .btn-green { background: var(--green-btn); }
        .btn-purple { background: var(--purple-btn); }
        .btn-print { background: #0288d1; width: auto; float: right; padding: 5px 15px; font-size: 0.8rem; margin-top: 0; }

        /* Worker Management */
        #workerFormArea { display: none; background: #e3f2fd; padding: 10px; border: 1px dashed #1976d2; margin-bottom: 15px; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .attendance-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; border-bottom: 1px solid #eee; }
        .attendance-item input { width: 60px; text-align: center; padding: 5px; border: 2px solid #90caf9; font-weight: bold;}

        /* Image Preview Style */
        #previewImg { display: none; width: 100px; height: 100px; object-fit: cover; border: 1px solid #ccc; margin-top: 10px; border-radius: 4px; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background: #eee; }
        
        /* Table Image */
        .table-img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #999; border-radius: 4px; display: block; margin-top: 5px; }

        /* --- PREMIUM BILL STYLES --- */
        #billResultArea { display: none; margin-top: 20px; border: 2px solid #000; padding: 20px; background: #fff; }
        .bill-header { text-align: center; margin-bottom: 20px; }
        .bill-title { font-size: 1.5rem; font-weight: bold; text-decoration: underline; margin-bottom: 15px; text-align: center; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
        .bill-total-line { border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; font-size: 1.2rem; font-weight: bold; }
        .bill-logo-text { color: var(--primary); font-weight: bold; font-size: 1.2rem; text-align: center; }

        /* --- PRINT / PDF SETTINGS (FIXED CUTTING ISSUE) --- */
        @media print {
            @page { margin: 5mm; size: A4; } /* Set A4 size with small margin */
            body { background: white; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .app-container { 
                box-shadow: none; 
                border: none; 
                width: 100%; 
                max-width: 100%; 
                padding: 0;
                margin: 0;
            }
            .section-box { border: 1px solid #000; margin-bottom: 10px; break-inside: avoid; }
            
            /* Table adjustments for print */
            table { font-size: 11px; width: 100%; }
            th, td { padding: 4px; border: 1px solid #000; }
            
            /* Ensure images print */
            img { max-width: 100%; break-inside: avoid; }
            .table-img { width: 60px; height: 60px; } /* Smaller image for print */

            #billResultArea { display: block !important; border: 2px solid #000; width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<div class="app-container">

    <div class="main-header">
        <h2>Shree Vaibhav Laxmi Enterprises</h2>
        <p>Supervisor: Siddharth Yadav | Tracking reports</p>
    </div>

    <div class="no-print">
        <button class="btn-blue" onclick="toggleWorkerForm()">+ Worker Add Karein (Manage List)</button>
        <div id="workerFormArea">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="newWorkerName" placeholder="Name">
                <select id="newWorkerType">
                    <option value="Mistri">Mistri</option>
                    <option value="Helper">Helper</option>
                    <option value="Labour">Labour</option>
                </select>
                <input type="number" id="newWorkerRate" placeholder="Rate ₹" style="width: 80px;">
            </div>
            <button onclick="addWorker()" style="background: #0d47a1; margin-top: 5px;">Save Worker</button>
            <ul id="workerListDisplay" style="margin: 10px 0 0 20px; font-size: 0.9rem;"></ul>
        </div>
    </div>
    <br>

    <div class="section-box no-print">
        <div class="section-title">Daily Entry (रोज़ का काम)</div>
        <label>Date (तारीख):</label>
        <input type="date" id="entryDate">
        <label>Site Name (साइट का नाम):</label>
        <input type="text" id="siteName" placeholder="Example: Gupta Ji House">

        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 15px;">
            <label style="margin-top:0;">Worker Hajari (हाजिरी):</label>
            <div id="attendanceContainer"><p style="color:#666; text-align:center;">No workers added.</p></div>
        </div>

        <div class="row-2">
            <div><label style="color: green;">Maal Aaya (IN):</label><textarea id="matIn" rows="2"></textarea></div>
            <div><label style="color: red;">Maal Laga (OUT):</label><textarea id="matOut" rows="2"></textarea></div>
        </div>

        <label>Work Description & Photo:</label>
        <textarea id="workDesc" rows="2" placeholder="Aaj kya kaam hua..."></textarea>
        
        <input type="file" id="sitePhoto" accept="image/*" onchange="handleImage(this)" style="margin-top:5px;">
        <input type="hidden" id="imgBase64"> <img id="previewImg" src="" alt="Preview">

        <button class="btn-green" onclick="saveDailyRecord()">Save Daily Record</button>
    </div>

    <div class="section-box no-print">
        <div class="section-title hisab-title">Hisab Kitab (Calculator)</div>
        <select id="calcWorker"><option value="">Select Worker...</option></select>
        <div class="row-2">
            <div><label>From:</label><input type="date" id="dateFrom"></div>
            <div><label>To:</label><input type="date" id="dateTo"></div>
        </div>
        <button class="btn-purple" onclick="generateBill()">Check Hisab (Generate Bill)</button>
    </div>

    <div id="billResultArea"></div>

    <div class="section-box">
        <div class="section-title" style="background:#eee; border-left-color:#333; display:flex; justify-content:space-between; align-items:center;">
            Saved Records
            <button class="btn-print no-print" onclick="window.print()">Print / Save PDF</button>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th width="15%">Date / Site</th>
                        <th width="35%">Work & Material</th>
                        <th width="40%">Worker Payment</th>
                        <th width="10%" class="no-print">Del</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- STORAGE & INIT ---
    function getWorkers() { try { return JSON.parse(localStorage.getItem('svle_workers')) || []; } catch(e){ return []; } }
    function getRecords() { try { return JSON.parse(localStorage.getItem('svle_records')) || []; } catch(e){ return []; } }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        loadWorkerUI();
        loadRecordsTable();
    });

    // --- IMAGE HANDLING (NEW) ---
    function handleImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Limit size to 1MB to prevent crashes
            if(file.size > 1024 * 1024) {
                alert("Photo bohot badi hai! 1MB se chhoti photo use karein.");
                input.value = ""; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                // Show Preview
                const img = document.getElementById('previewImg');
                img.src = e.target.result;
                img.style.display = 'block';
                // Store in Hidden Input
                document.getElementById('imgBase64').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    // --- WORKER LOGIC ---
    function toggleWorkerForm() {
        const d = document.getElementById('workerFormArea');
        d.style.display = d.style.display==='none'?'block':'none';
    }
    function addWorker() {
        const name = document.getElementById('newWorkerName').value.trim();
        const type = document.getElementById('newWorkerType').value;
        const rate = document.getElementById('newWorkerRate').value;
        if(!name || !rate) return alert("Details bharein!");
        
        const w = getWorkers();
        w.push({id:Date.now(), name, type, rate});
        localStorage.setItem('svle_workers', JSON.stringify(w));
        document.getElementById('newWorkerName').value='';
        document.getElementById('newWorkerRate').value='';
        alert("Worker Added");
        loadWorkerUI();
    }
    function loadWorkerUI() {
        const w = getWorkers();
        document.getElementById('workerListDisplay').innerHTML = w.map(x=>`<li>${x.name} (${x.type}) - ${x.rate} <span onclick="delWorker(${x.id})" style="color:red;cursor:pointer;">[X]</span></li>`).join('');
        document.getElementById('calcWorker').innerHTML = '<option value="">Select Worker...</option>' + w.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
        
        const att = document.getElementById('attendanceContainer');
        if(w.length>0) att.innerHTML = w.map(x=>`<div class="attendance-item"><span><b>${x.name}</b> <small>(${x.rate})</small></span><input type="number" step="0.5" class="hajari-inp" data-rate="${x.rate}" data-name="${x.name}" placeholder="0"></div>`).join('');
        else att.innerHTML='<p style="text-align:center;color:#777;">No workers found.</p>';
    }
    function delWorker(id){ if(confirm("Remove?")){ localStorage.setItem('svle_workers', JSON.stringify(getWorkers().filter(x=>x.id!==id))); loadWorkerUI(); } }

    // --- SAVE RECORD (UPDATED) ---
    function saveDailyRecord() {
        try {
            const date = document.getElementById('entryDate').value;
            const site = document.getElementById('siteName').value;
            const matIn = document.getElementById('matIn').value;
            const matOut = document.getElementById('matOut').value;
            const workDesc = document.getElementById('workDesc').value;
            const imgData = document.getElementById('imgBase64').value; // Get Image Data

            if(!date || !site) return alert("Date aur Site Name zaruri hai.");

            let hajariData = [], totalPay = 0;
            document.querySelectorAll('.hajari-inp').forEach(i => {
                const v = parseFloat(i.value);
                if(v>0) {
                    const pay = v * parseFloat(i.getAttribute('data-rate'));
                    hajariData.push({name:i.getAttribute('data-name'), val:v, pay});
                    totalPay += pay;
                }
            });

            const rec = { id:Date.now(), date, site, matIn, matOut, workDesc, imgData, hajariData, totalPay };
            const all = getRecords();
            all.push(rec);
            localStorage.setItem('svle_records', JSON.stringify(all));
            
            alert("Saved!");
            // Reset
            document.getElementById('siteName').value='';
            document.getElementById('matIn').value='';
            document.getElementById('matOut').value='';
            document.getElementById('workDesc').value='';
            document.getElementById('sitePhoto').value='';
            document.getElementById('imgBase64').value='';
            document.getElementById('previewImg').style.display='none';
            document.querySelectorAll('.hajari-inp').forEach(i=>i.value='');
            loadRecordsTable();

        } catch(e) { alert("Error: Storage Full or Invalid Data"); }
    }

    // --- TABLE DISPLAY (UPDATED) ---
    function loadRecordsTable() {
        const r = getRecords().sort((a,b)=>new Date(b.date)-new Date(a.date));
        const tb = document.getElementById('recordsTableBody');
        tb.innerHTML = '';
        
        r.forEach(x => {
            let wHtml = x.hajariData ? x.hajariData.map(h=>`<div>${h.name}(${h.val}): <b>₹${h.pay}</b></div>`).join('') : '';
            
            // Image Logic
            let imgHtml = '';
            if(x.imgData) {
                imgHtml = `<img src="${x.imgData}" class="table-img" alt="Work Photo">`;
            }

            tb.innerHTML += `
                <tr>
                    <td><b>${x.date}</b><br>${x.site}</td>
                    <td>
                        ${x.workDesc ? `<div><b>Work:</b> ${x.workDesc}</div>` : ''}
                        ${imgHtml} 
                        ${x.matIn ? `<div style="color:green;font-size:0.8rem;margin-top:3px;">IN: ${x.matIn}</div>` : ''}
                        ${x.matOut ? `<div style="color:red;font-size:0.8rem;">OUT: ${x.matOut}</div>` : ''}
                    </td>
                    <td>${wHtml || '<span style="color:#aaa">No Worker</span>'}
                        <div style="border-top:1px dashed #ccc; margin-top:5px; font-weight:bold;">Total: ₹${x.totalPay||0}</div>
                    </td>
                    <td class="no-print"><button style="background:#c62828;padding:4px;" onclick="delRec(${x.id})">X</button></td>
                </tr>`;
        });
    }
    function delRec(id){ if(confirm("Delete Record?")){ localStorage.setItem('svle_records', JSON.stringify(getRecords().filter(x=>x.id!==id))); loadRecordsTable(); } }

    // --- BILL GENERATION ---
    function generateBill() {
        const wid = document.getElementById('calcWorker').value;
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        if(!wid) return alert("Worker select karein");
        
        const wName = document.getElementById('calcWorker').options[document.getElementById('calcWorker').selectedIndex].text;
        const recs = getRecords();
        let days=0, haj=0, money=0;

        recs.forEach(r => {
            if(from && r.date < from) return;
            if(to && r.date > to) return;
            const entry = (r.hajariData||[]).find(h=>h.name===wName);
            if(entry) { days++; haj+=parseFloat(entry.val); money+=parseFloat(entry.pay); }
        });

        const html = `
            <div class="bill-header">
                <div class="bill-logo-text">Shree Vaibhav Laxmi Enterprises</div>
                <div style="font-size:0.9rem;">Supervisor : Siddharth Yadav</div>
            </div>
            <hr style="border-top: 2px solid #000;">
            <div class="bill-title">PAYMENT BILL</div>
            <div style="margin-bottom: 20px;">
                <div class="bill-row"><b>Bill No:</b> ${Math.floor(1000+Math.random()*9000)}</div>
                <div class="bill-row"><b>Worker:</b> ${wName}</div>
                <div class="bill-row"><b>Date:</b> ${from||'Start'} to ${to||'Today'}</div>
            </div>
            <div class="bill-row"><span>Days Worked</span><span>${days}</span></div>
            <div class="bill-row"><span>Total Hajari</span><span>${haj}</span></div>
            <div class="bill-total-line bill-row"><span>TOTAL</span><span>₹ ${money}</span></div>
            <div style="text-align:center; margin-top:30px;">
                <button class="no-print btn-blue" onclick="document.getElementById('billResultArea').style.display='none'">Close</button>
                <button class="no-print btn-print" onclick="window.print()" style="float:none;width:auto;">Print Bill</button>
            </div>
        `;
        const div = document.getElementById('billResultArea');
        div.innerHTML = html;
        div.style.display = 'block';
        div.scrollIntoView({behavior:'smooth'});
    }
</script>
</body>
</html>
