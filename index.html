<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Tracker Pro V4 (Auto-Compress)</title>
    <style>
        :root {
            --primary: #d32f2f;
            --blue-btn: #1976d2;
            --green-btn: #388e3c;
            --purple-btn: #7b1fa2;
            --bg: #f5f5f5;
            --border: #ddd;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        .app-container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .main-header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .main-header h2 { color: var(--primary); margin: 0; text-transform: uppercase; font-weight: 800; font-size: 1.4rem; }
        
        .section-box { background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section-title { font-weight: bold; border-left: 4px solid var(--blue-btn); padding-left: 8px; margin-bottom: 15px; background: #e3f2fd; padding: 5px 8px; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; background: #fff; }
        label { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; margin-top: 5px; }
        .btn-blue { background: var(--blue-btn); }
        .btn-green { background: var(--green-btn); }
        .btn-purple { background: var(--purple-btn); }
        .btn-print { background: #0288d1; width: auto; float: right; padding: 5px 15px; font-size: 0.8rem; }
        .btn-danger { background: #c62828; font-size: 0.8rem; padding: 8px; margin-top: 20px; }

        /* Worker & Attendance */
        #workerFormArea { display: none; background: #e3f2fd; padding: 10px; border: 1px dashed #1976d2; margin-bottom: 15px; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .attendance-item { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 5px; align-items: center; background: white; padding: 8px; border-bottom: 1px solid #eee; }
        .hajari-inp { border: 2px solid #90caf9; text-align: center; } 
        .advance-inp { border: 2px solid #ef9a9a; color: #c62828; text-align: center; }

        /* Images */
        #previewImg { display: none; width: 100px; height: 100px; object-fit: cover; border: 1px solid #ccc; margin-top: 10px; border-radius: 4px; }
        .table-img { width: 60px; height: 60px; object-fit: cover; border: 1px solid #999; border-radius: 4px; display: block; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background: #eee; }

        /* Bill & Stamp */
        #billResultArea { display: none; margin-top: 20px; border: 2px solid #000; padding: 20px; background: #fff; position: relative; overflow: hidden; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
        .stamp-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); font-size: 4rem; font-weight: 900; border: 6px solid; padding: 10px 40px; text-transform: uppercase; opacity: 0.3; pointer-events: none; border-radius: 10px; }
        .stamp-paid { color: #2e7d32; border-color: #2e7d32; }
        .stamp-unpaid { color: #c62828; border-color: #c62828; }

        @media print {
            .no-print { display: none !important; }
            .section-box, #billResultArea { border: 1px solid #000; break-inside: avoid; }
            .stamp-box { opacity: 0.4 !important; display: block !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="main-header">
        <h2>Shree Vaibhav Laxmi Enterprises</h2>
        <p>Supervisor: Siddharth Yadav | V4 (Auto-Compress)</p>
    </div>

    <div class="no-print">
        <button class="btn-blue" onclick="toggleWorkerForm()">+ Worker Add (Mistri/Labour)</button>
        <div id="workerFormArea">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="newWorkerName" placeholder="Name">
                <select id="newWorkerType"><option value="Mistri">Mistri</option><option value="Helper">Helper</option><option value="Labour">Labour</option></select>
                <input type="number" id="newWorkerRate" placeholder="Rate ₹" style="width: 80px;">
            </div>
            <button onclick="addWorker()" style="background: #0d47a1;">Save Worker</button>
            <ul id="workerListDisplay" style="margin: 10px 0 0 20px; font-size: 0.9rem;"></ul>
        </div>
    </div>
    <br>

    <div class="section-box no-print">
        <div class="section-title">Daily Entry</div>
        <input type="date" id="entryDate">
        <input type="text" id="siteName" placeholder="Site Name (e.g. Gupta Ji)">

        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom:10px;">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr; font-weight:bold; text-align:center; font-size:0.8rem;">
                <span>Name</span><span>Hajari</span><span style="color:red">Adv ₹</span>
            </div>
            <div id="attendanceContainer"><p style="text-align:center;color:#777;">No workers.</p></div>
        </div>

        <div class="row-2">
            <textarea id="matIn" rows="2" placeholder="Maal Aaya (IN)"></textarea>
            <textarea id="matOut" rows="2" placeholder="Maal Laga (OUT)"></textarea>
        </div>

        <textarea id="workDesc" rows="2" placeholder="Work Description..."></textarea>
        
        <label>Site Photo (Auto-Compressed):</label>
        <input type="file" id="sitePhoto" accept="image/*" onchange="handleImageCompress(this)">
        <input type="hidden" id="imgBase64"> 
        <img id="previewImg" src="" alt="Preview">
        <p id="imgStatus" style="font-size:0.8rem; color:green; display:none;">Image Compressed & Ready!</p>

        <button class="btn-green" onclick="saveDailyRecord()">Save Daily Record</button>
    </div>

    <div class="section-box no-print">
        <div class="section-title hisab-title">Monthly Hisab & Stamp</div>
        <select id="calcWorker"><option value="">Select Worker...</option></select>
        <div class="row-2">
            <input type="date" id="dateFrom">
            <input type="date" id="dateTo">
        </div>
        <label>Payment Status:</label>
        <select id="billStatus" style="border: 2px solid #1976d2; font-weight:bold;">
            <option value="UNPAID">UNPAID (Baki Hai)</option>
            <option value="PAID">PAID (De Diya)</option>
        </select>
        <button class="btn-purple" onclick="generateBill()">Generate Bill</button>
    </div>

    <div id="billResultArea"></div>

    <div class="section-box">
        <div class="section-title" style="display:flex; justify-content:space-between;">
            Saved Records <button class="btn-print no-print" onclick="window.print()">Print</button>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th width="20%">Date/Site</th><th width="40%">Work</th><th width="40%">Payment</th><th class="no-print">X</th></tr>
                </thead>
                <tbody id="recordsTableBody"></tbody>
            </table>
        </div>
        <button class="btn-danger no-print" onclick="clearAllData()">⚠️ Reset All Data (Format)</button>
    </div>

</div>

<script>
    // --- INIT ---
    function getWorkers() { try { return JSON.parse(localStorage.getItem('svle_workers')) || []; } catch(e){ return []; } }
    function getRecords() { try { return JSON.parse(localStorage.getItem('svle_records')) || []; } catch(e){ return []; } }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        loadWorkerUI();
        loadRecordsTable();
    });

    // --- NEW: IMAGE COMPRESSOR (Fixes "Error Saving Data") ---
    function handleImageCompress(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Create Canvas to resize
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize logic: Max width 600px
                    const maxWidth = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG Quality 0.6 (60%)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    document.getElementById('imgBase64').value = dataUrl;
                    document.getElementById('previewImg').src = dataUrl;
                    document.getElementById('previewImg').style.display = 'block';
                    document.getElementById('imgStatus').style.display = 'block';
                    document.getElementById('imgStatus').innerText = "Photo Compressed: Ready to Save!";
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    // --- WORKER ---
    function toggleWorkerForm() { document.getElementById('workerFormArea').style.display = document.getElementById('workerFormArea').style.display==='block'?'none':'block'; }
    function addWorker() {
        const name = document.getElementById('newWorkerName').value;
        const type = document.getElementById('newWorkerType').value;
        const rate = document.getElementById('newWorkerRate').value;
        if(!name || !rate) return alert("Fill details");
        const w = getWorkers();
        w.push({id:Date.now(), name, type, rate});
        localStorage.setItem('svle_workers', JSON.stringify(w));
        alert("Worker Added"); loadWorkerUI();
        document.getElementById('newWorkerName').value='';
    }
    function loadWorkerUI() {
        const w = getWorkers();
        document.getElementById('workerListDisplay').innerHTML = w.map(x=>`<li>${x.name} - ${x.rate} <span onclick="delW(${x.id})" style="color:red;cursor:pointer;">[X]</span></li>`).join('');
        document.getElementById('calcWorker').innerHTML = '<option value="">Select...</option>' + w.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
        const att = document.getElementById('attendanceContainer');
        if(w.length>0) att.innerHTML = w.map(x=>`<div class="attendance-item"><span>${x.name}</span><input type="number" step="0.5" class="hajari-inp" data-id="${x.id}" data-rate="${x.rate}" data-name="${x.name}" placeholder="H"><input type="number" class="advance-inp" id="adv_${x.id}" placeholder="₹"></div>`).join('');
        else att.innerHTML='<p style="text-align:center;color:#777;">No workers.</p>';
    }
    function delW(id){ if(confirm("Remove?")){ localStorage.setItem('svle_workers', JSON.stringify(getWorkers().filter(x=>x.id!==id))); loadWorkerUI(); } }

    // --- SAVE RECORD (With Better Error Handling) ---
    function saveDailyRecord() {
        try {
            const date = document.getElementById('entryDate').value;
            const site = document.getElementById('siteName').value;
            if(!date || !site) return alert("Date and Site Name required!");

            let hajariData = [], totalPay = 0, totalAdv = 0;
            document.querySelectorAll('.hajari-inp').forEach(i => {
                const v = parseFloat(i.value), adv = parseFloat(document.getElementById(`adv_${i.getAttribute('data-id')}`).value)||0;
                if(v>0 || adv>0) {
                    const pay = (v||0) * parseFloat(i.getAttribute('data-rate'));
                    hajariData.push({name:i.getAttribute('data-name'), val:v||0, pay, advance:adv});
                    totalPay+=pay; totalAdv+=adv;
                }
            });

            const rec = { 
                id:Date.now(), 
                date, site, 
                matIn: document.getElementById('matIn').value, 
                matOut: document.getElementById('matOut').value, 
                workDesc: document.getElementById('workDesc').value, 
                imgData: document.getElementById('imgBase64').value, // This is now compressed
                hajariData, totalPay, totalAdv 
            };

            const all = getRecords();
            all.push(rec);
            localStorage.setItem('svle_records', JSON.stringify(all));
            alert("✅ Record Saved Successfully!");
            location.reload(); // Refresh to clear forms
        } catch(e) {
            alert("❌ ERROR: Storage Full! Purana data delete karein ya photo na dalein.\n\nTechnical Error: " + e.message);
        }
    }

    // --- DISPLAY ---
    function loadRecordsTable() {
        const tb = document.getElementById('recordsTableBody'); tb.innerHTML='';
        getRecords().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(x => {
            let wHtml = (x.hajariData||[]).map(h=>`<div>${h.name}: ${h.val}H ${h.advance>0?`<span style="color:red">(-${h.advance})</span>`:''}</div>`).join('');
            tb.innerHTML += `<tr>
                <td><b>${x.date}</b><br>${x.site}</td>
                <td>${x.workDesc}${x.imgData?`<img src="${x.imgData}" class="table-img">`:''}</td>
                <td>${wHtml}<hr>Net: ₹${x.totalPay-x.totalAdv}</td>
                <td class="no-print"><button onclick="delRec(${x.id})" style="background:red;padding:2px;">X</button></td>
            </tr>`;
        });
    }
    function delRec(id){ if(confirm("Delete?")){ localStorage.setItem('svle_records', JSON.stringify(getRecords().filter(x=>x.id!==id))); loadRecordsTable(); } }
    
    // --- RESET ---
    function clearAllData() {
        if(confirm("⚠️ DANGER: Sab kuch delete ho jayega (Workers + Records). Pakka?")) {
            localStorage.clear();
            alert("All Data Cleared.");
            location.reload();
        }
    }

    // --- BILL ---
    function generateBill() {
        const wid = document.getElementById('calcWorker').value;
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const status = document.getElementById('billStatus').value;
        
        if(!wid) return alert("Worker Select Karein");
        const wName = document.getElementById('calcWorker').options[document.getElementById('calcWorker').selectedIndex].text;
        
        let days=0, earn=0, adv=0;
        getRecords().forEach(r => {
            if(from && r.date<from) return; if(to && r.date>to) return;
            const h = (r.hajariData||[]).find(x=>x.name===wName);
            if(h) { days+=parseFloat(h.val); earn+=parseFloat(h.pay); adv+=parseFloat(h.advance); }
        });

        document.getElementById('billResultArea').innerHTML = `
            <div class="stamp-box ${status==='PAID'?'stamp-paid':'stamp-unpaid'}">${status}</div>
            <div style="text-align:center;font-weight:bold;margin-bottom:10px;">
                SHREE VAIBHAV LAXMI ENTERPRISES<br>Worker Statement
            </div>
            <hr>
            <p><b>Name:</b> ${wName}</p>
            <p><b>Days:</b> ${days}</p>
            <div class="bill-row" style="color:green"><span>Total Kamayi:</span><span>₹${earn}</span></div>
            <div class="bill-row" style="color:red"><span>(-) Advance:</span><span>₹${adv}</span></div>
            <div class="bill-row" style="background:#eee;padding:5px;font-weight:bold;margin-top:5px;"><span>NET PAYABLE:</span><span>₹${earn-adv}</span></div>
            <button class="no-print btn-print" onclick="window.print()" style="margin-top:20px;width:100%">Print Bill</button>
            <button class="no-print btn-blue" onclick="document.getElementById('billResultArea').innerHTML=''">Close</button>
        `;
        document.getElementById('billResultArea').style.display='block';
    }
</script>
</body>
</html>
