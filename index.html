<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHREE VAIBHAV LAXMI ENTERPRISES- Ultimate System</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background-color: #f4f6f9; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { color: #2c3e50; text-align: center; margin: 0; }
        .sub-header { text-align: center; color: #7f8c8d; font-size: 14px; margin-bottom: 15px; }

        /* TABS */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #f1f1f1; cursor: pointer; font-size: 16px; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* SECTIONS & INPUTS */
        .section-title { background-color: #2c3e50; color: white; padding: 10px; margin-top: 20px; border-radius: 4px; font-weight: bold; }
        .summary-box { background-color: #e8f6f3; border: 1px solid #1abc9c; padding: 10px; margin-top: 10px; display: flex; justify-content: space-around; font-weight: bold; color: #16a085; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
        th { background-color: #eee; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* PHOTOS */
        .photo-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .photo-preview { width: 100px; height: 100px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px; }

        /* SIGNATURES */
        .row { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        .col { flex: 1; min-width: 250px; text-align: center; }
        canvas { border: 2px dashed #bdc3c7; background: #fff; cursor: crosshair; touch-action: none; width: 100%; height: 120px; }
        .btn-clear-sig { background: #e74c3c; color: white; border: none; padding: 5px 10px; font-size: 12px; cursor: pointer; margin-top: 5px; border-radius: 4px; }

        /* BUTTONS */
        .btn-add { background: #27ae60; color: white; padding: 8px; border: none; cursor: pointer; border-radius: 4px; margin-top: 5px; }
        .btn-save { background: #2980b9; width: 100%; padding: 15px; color: white; font-size: 18px; border: none; margin-top: 20px; cursor: pointer; border-radius: 5px; }
        .btn-pdf { background: #e67e22; width: 100%; padding: 15px; color: white; font-size: 18px; border: none; margin-top: 10px; cursor: pointer; border-radius: 5px; }
        .btn-download { background: #8e44ad; color: white; padding: 10px; border: none; cursor: pointer; border-radius: 4px; float: right; margin-bottom: 10px; }

        /* SEARCH BAR */
        .search-bar { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #3498db; border-radius: 25px; outline: none; }

        @media print {
            .tabs, .btn-add, .btn-save, .btn-pdf, .btn-download, #dbSection, input[type="file"], .btn-clear-sig { display: none !important; }
            #entrySection { display: block !important; }
            body { background: white; }
            .container { box-shadow: none; border: none; max-width: 100%; }
            canvas { border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SHREE VAIBHAV LAXMI ENTERPRISES</h1>
    <div class="sub-header">TRACK LIST AND WORKERS RECORDS</div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('entry')">üìù Daily Report Entry</button>
        <button class="tab-btn" onclick="switchTab('db')">üîç Search Old Records</button>
    </div>

    <div id="entrySection" class="tab-content active">
        <form id="reportForm">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Date:</label><input type="date" id="mainDate"></div>
                <div style="flex:1"><label>Site:</label><input type="text" id="siteName" placeholder="Site Name"></div>
            </div>

            <div class="section-title">Labour Details</div>
            <div class="summary-box">
                <span>Carp: <span id="cCarp">0</span></span>
                <span>Fit: <span id="cFit">0</span></span>
                <span>Help: <span id="cHelp">0</span></span>
                <span>Total: <span id="cTotal">0</span></span>
            </div>

            <div style="overflow-x:auto;">
                <table id="labourTable">
                    <thead>
                        <tr>
                            <th>Name</th><th>Type</th><th>Rate</th><th>Att</th><th>Adv</th><th>Total</th><th>X</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-add" onclick="addWorkerRow()">+ Add Worker</button>

            <div class="section-title">Work & Material</div>
            <textarea id="materialBox" rows="2" placeholder="Material In/Out..."></textarea>
            <textarea id="workBox" rows="2" placeholder="Work Done Description..."></textarea>
            
            <label style="margin-top:10px;"><strong>Attach Site Photos:</strong></label>
            <input type="file" accept="image/*" multiple onchange="previewImages(this)">
            <div class="photo-grid" id="photoContainer"></div>

            <div class="section-title">Issues / Requirements</div>
            <textarea id="issueBox" rows="2" placeholder="Urgent needs..."></textarea>

            <div class="row">
                <div class="col">
                    <label>Supervisor Signature</label>
                    <canvas id="sigCanvas1"></canvas>
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('sigCanvas1')">Clear</button>
                </div>
                <div class="col">
                    <label>Engineer/Client Signature</label>
                    <canvas id="sigCanvas2"></canvas>
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('sigCanvas2')">Clear</button>
                </div>
            </div>

            <button type="button" class="btn-save" onclick="saveToDatabase()">üíæ SAVE DATA (Labour Only)</button>
            <button type="button" class="btn-pdf" onclick="window.print()">üñ®Ô∏è PRINT / PDF</button>
        </form>
    </div>

    <div id="dbSection" class="tab-content">
        <button onclick="downloadExcel()" class="btn-download">‚¨á Download Excel</button>
        <input type="text" id="searchInput" class="search-bar" placeholder="üîç Search by Name, Date, or Site..." onkeyup="searchDatabase()">
        
        <div style="overflow-x:auto;">
            <table id="searchTable">
                <thead>
                    <tr style="background:#34495e; color:white;">
                        <th>Date</th><th>Name</th><th>Type</th><th>Site</th><th>Rate</th><th>Att</th><th>Adv</th><th>Payable</th>
                    </tr>
                </thead>
                <tbody id="dbBody"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- INITIALIZATION ---
    document.getElementById('mainDate').valueAsDate = new Date();
    window.onload = function() {
        addWorkerRow();
        loadDatabase();
        setupCanvas('sigCanvas1'); // Setup signatures
        setupCanvas('sigCanvas2');
    };

    // --- TAB LOGIC ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(tabName === 'entry') {
            document.getElementById('entrySection').classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else {
            document.getElementById('dbSection').classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            loadDatabase();
        }
    }

    // --- WORKER & CALC LOGIC ---
    function addWorkerRow() {
        const table = document.getElementById("labourTable").getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        newRow.innerHTML = `
            <td><input type="text" class="w-name" placeholder="Name"></td>
            <td><select class="w-type" onchange="updateCounts()"><option>Carpenter</option><option>Fitter</option><option>Helper</option><option>Other</option></select></td>
            <td><input type="number" class="rate" oninput="calcRow(this)" placeholder="0"></td>
            <td><input type="number" class="att" oninput="calcRow(this)" placeholder="1"></td>
            <td><input type="number" class="adv" oninput="calcRow(this)" placeholder="0"></td>
            <td><input type="number" class="total" readonly style="background:#eee;"></td>
            <td><button onclick="deleteRow(this)" style="color:red; background:none; border:none; font-weight:bold;">x</button></td>
        `;
        updateCounts();
    }
    function calcRow(el) {
        const row = el.closest('tr');
        row.querySelector('.total').value = ((row.querySelector('.rate').value||0) * (row.querySelector('.att').value||0)) - (row.querySelector('.adv').value||0);
    }
    function deleteRow(btn) { btn.closest('tr').remove(); updateCounts(); }
    function updateCounts() {
        let counts = {Carpenter:0, Fitter:0, Helper:0, Other:0};
        document.querySelectorAll('.w-type').forEach(s => counts[s.value]++);
        document.getElementById('cCarp').innerText = counts.Carpenter;
        document.getElementById('cFit').innerText = counts.Fitter;
        document.getElementById('cHelp').innerText = counts.Helper;
        document.getElementById('cTotal').innerText = counts.Carpenter + counts.Fitter + counts.Helper + counts.Other;
    }

    // --- PHOTO PREVIEW LOGIC (NEW) ---
    function previewImages(input) {
        const container = document.getElementById('photoContainer');
        container.innerHTML = ""; // Clear old
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('photo-preview');
                    container.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    // --- SIGNATURE LOGIC (NEW) ---
    function setupCanvas(id) {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext('2d');
        // Fix resolution
        canvas.width = canvas.offsetWidth; 
        canvas.height = canvas.offsetHeight;
        
        let drawing = false;
        function start(e) { drawing = true; draw(e); }
        function end() { drawing = false; ctx.beginPath(); }
        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }
        canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start);
        canvas.addEventListener('mouseup', end); canvas.addEventListener('touchend', end);
        canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchmove', draw);
    }
    function clearCanvas(id) {
        const canvas = document.getElementById(id);
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- DATABASE & SAVE ---
    function saveToDatabase() {
        if(!confirm("Save labour data?")) return;
        const date = document.getElementById('mainDate').value;
        const site = document.getElementById('siteName').value || "Unknown";
        let newRecords = [];
        document.querySelectorAll('#labourTable tbody tr').forEach(row => {
            const name = row.querySelector('.w-name').value;
            if(name) {
                newRecords.push({
                    date: date, site: site, name: name,
                    type: row.querySelector('.w-type').value,
                    rate: row.querySelector('.rate').value,
                    att: row.querySelector('.att').value,
                    adv: row.querySelector('.adv').value,
                    payable: row.querySelector('.total').value
                });
            }
        });
        let existing = JSON.parse(localStorage.getItem('nirmalData')) || [];
        localStorage.setItem('nirmalData', JSON.stringify([...newRecords, ...existing]));
        alert("Data Saved!");
    }

    function loadDatabase(filter = "") {
        const tbody = document.getElementById('dbBody'); tbody.innerHTML = "";
        const data = JSON.parse(localStorage.getItem('nirmalData')) || [];
        data.filter(i => (i.name+i.date+i.site+i.type).toLowerCase().includes(filter.toLowerCase())).forEach(item => {
            tbody.innerHTML += `<tr><td>${item.date}</td><td><strong>${item.name}</strong></td><td>${item.type}</td><td>${item.site}</td><td>${item.rate}</td><td>${item.att}</td><td>${item.adv}</td><td style="font-weight:bold">${item.payable}</td></tr>`;
        });
    }
    function searchDatabase() { loadDatabase(document.getElementById('searchInput').value); }
    function downloadExcel() {
        const data = JSON.parse(localStorage.getItem('nirmalData')) || [];
        if(!data.length) return alert("No data!");
        let csv = "Date,Name,Type,Site,Rate,Att,Adv,Payable\n" + data.map(r => `${r.date},${r.name},${r.type},${r.site},${r.rate},${r.att},${r.adv},${r.payable}`).join("\n");
        const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "Nirmal_Labour_Data.csv"; link.click();
    }
</script>
</body>
                </html>
