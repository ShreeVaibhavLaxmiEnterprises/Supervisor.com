<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Fixed Tracker</title>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; padding: 10px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: #d32f2f; text-align: center; margin-top: 0; }
        .box { background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-blue { background: #1976d2; }
        .btn-green { background: #388e3c; }
        .btn-orange { background: #f57c00; }
        .btn-purple { background: #7b1fa2; }
        .btn-red { background: #c62828; }
        .row { display: flex; gap: 10px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #eee; }
        
        /* Hidden Elements */
        #workerForm { display: none; background: #e3f2fd; padding: 10px; margin-bottom: 10px; }
        #billArea { display: none; border: 2px solid black; padding: 15px; margin-top: 20px; background: white; }

        @media print { .no-print { display: none !important; } #billArea { display: block !important; } }
    </style>
</head>
<body>

<div class="container">
    <h2>Shree Vaibhav Laxmi Ent.</h2>

    <div class="no-print">
        <button class="btn-blue" onclick="toggleWorker()">+ Worker Add Karein</button>
        <div id="workerForm">
            <input type="text" id="wName" placeholder="Name">
            <input type="number" id="wRate" placeholder="Rate ₹">
            <button onclick="saveWorker()" class="btn-blue">Save Worker</button>
        </div>
        <div id="workerList" style="margin-top:10px; font-size:0.9rem;"></div>
    </div>

    <div class="box no-print">
        <h3 style="margin:0; color:#388e3c;">1. Daily Work Entry</h3>
        <input type="date" id="dateEntry">
        <input type="text" id="siteName" placeholder="Site Name">
        
        <div style="background:#e3f2fd; padding:10px; margin-top:10px;">
            <label>Worker Hajari:</label>
            <div id="attList">No workers added.</div>
        </div>

        <div class="row">
            <textarea id="matIn" placeholder="Maal Aaya (IN)"></textarea>
            <textarea id="matOut" placeholder="Maal Laga (OUT)"></textarea>
        </div>
        <textarea id="workDesc" placeholder="Kaam ki details..."></textarea>
        
        <label>Photo:</label>
        <input type="file" accept="image/*" onchange="compressImg(this)">
        <input type="hidden" id="imgData">
        <p id="imgMsg" style="color:green; display:none; font-size:0.8rem;">Photo Selected!</p>

        <button onclick="saveDaily()" class="btn-green">Save Record</button>
    </div>

    <div class="box no-print">
        <h3 style="margin:0; color:#f57c00;">2. Payment Entry (Cash)</h3>
        <select id="payWorker"><option>Select Worker...</option></select>
        <div class="row">
            <input type="date" id="payDate">
            <input type="number" id="payAmt" placeholder="Amount ₹">
        </div>
        <button onclick="savePayment()" class="btn-orange">Save Payment</button>
    </div>

    <div class="box no-print">
        <h3 style="margin:0; color:#7b1fa2;">3. Generate Hisab</h3>
        <select id="billWorker"><option>Select Worker...</option></select>
        <button onclick="makeBill()" class="btn-purple">Generate Bill</button>
    </div>

    <div id="billArea"></div>

    <div class="box">
        <h3>Saved Records</h3>
        <div style="overflow-x:auto;">
            <table id="recTable">
                <thead><tr><th>Date/Site</th><th>Detail</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button onclick="resetAll()" class="btn-red no-print" style="margin-top:20px;">RESET ALL DATA (Format)</button>
    </div>
</div>

<script>
    // --- GLOBAL FUNCTIONS (Takki Button Hamesha Kaam Kare) ---
    
    // 1. Load Data Safely
    function getData(key) {
        try {
            const d = localStorage.getItem(key);
            return d ? JSON.parse(d) : [];
        } catch(e) {
            console.error("Data Error", e);
            return [];
        }
    }

    // 2. Initialize
    window.onload = function() {
        document.getElementById('dateEntry').valueAsDate = new Date();
        document.getElementById('payDate').valueAsDate = new Date();
        renderUI();
    };

    function renderUI() {
        const workers = getData('svle_workers');
        const records = getData('svle_records');
        
        // Worker Lists
        let listHtml = "", optHtml = "<option value=''>Select Worker...</option>";
        workers.forEach(w => {
            listHtml += `<div><b>${w.name}</b> (${w.rate}) <span onclick="delWorker(${w.id})" style="color:red;cursor:pointer;">[X]</span></div>`;
            optHtml += `<option value="${w.id}">${w.name}</option>`;
        });
        document.getElementById('workerList').innerHTML = listHtml || "No workers.";
        document.getElementById('payWorker').innerHTML = optHtml;
        document.getElementById('billWorker').innerHTML = optHtml;

        // Attendance Inputs
        let attHtml = "";
        workers.forEach(w => {
            attHtml += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; border-bottom:1px solid #ddd;">
                <span style="width:40%">${w.name}</span>
                <input type="number" class="h-inp" data-id="${w.id}" data-rate="${w.rate}" placeholder="H" style="width:25%">
                <input type="number" class="a-inp" id="adv_${w.id}" placeholder="Adv" style="width:25%">
            </div>`;
        });
        document.getElementById('attList').innerHTML = attHtml || "Add workers first.";

        // Records Table
        let tblHtml = "";
        records.sort((a,b) => b.id - a.id).forEach(r => {
            if(r.type === 'pay') {
                tblHtml += `<tr style="background:#fff3e0">
                    <td>${r.date}<br><b>PAYMENT</b></td>
                    <td style="color:#e65100">Paid ₹${r.amt} to ${r.wName}</td>
                    <td><button onclick="delRec(${r.id})" style="padding:2px;background:red;">X</button></td>
                </tr>`;
            } else {
                tblHtml += `<tr>
                    <td>${r.date}<br>${r.site}</td>
                    <td>${r.desc} <br> ${r.img ? '<b style="color:green">[Photo]</b>' : ''} <br> <small>Work Total: ₹${r.totalEarn}</small></td>
                    <td><button onclick="delRec(${r.id})" style="padding:2px;background:red;">X</button></td>
                </tr>`;
            }
        });
        document.getElementById('recTable').querySelector('tbody').innerHTML = tblHtml;
    }

    // --- ACTIONS ---

    function toggleWorker() {
        const x = document.getElementById('workerForm');
        x.style.display = x.style.display === 'none' ? 'block' : 'none';
    }

    function saveWorker() {
        const name = document.getElementById('wName').value;
        const rate = document.getElementById('wRate').value;
        if(!name) return alert("Naam likho!");
        
        const w = getData('svle_workers');
        w.push({ id: Date.now(), name, rate });
        localStorage.setItem('svle_workers', JSON.stringify(w));
        document.getElementById('wName').value = "";
        renderUI();
    }

    function delWorker(id) {
        if(confirm("Delete Worker?")) {
            const w = getData('svle_workers').filter(x => x.id !== id);
            localStorage.setItem('svle_workers', JSON.stringify(w));
            renderUI();
        }
    }

    // COMPRESS IMAGE (Simple Version)
    function compressImg(input) {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 500; // Small size for safety
                    let w = img.width, h = img.height;
                    if(w > maxW) { h *= maxW/w; w = maxW; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    document.getElementById('imgData').value = canvas.toDataURL('image/jpeg', 0.5);
                    document.getElementById('imgMsg').style.display = 'block';
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveDaily() {
        try {
            const date = document.getElementById('dateEntry').value;
            const site = document.getElementById('siteName').value;
            if(!date || !site) return alert("Date aur Site Name zaruri h!");

            // Calculate Hajari
            let attData = [], totalEarn = 0, totalAdv = 0;
            const workers = getData('svle_workers');
            document.querySelectorAll('.h-inp').forEach(inp => {
                const val = parseFloat(inp.value);
                const wid = parseInt(inp.dataset.id);
                const adv = parseFloat(document.getElementById('adv_'+wid).value) || 0;
                
                if(val > 0 || adv > 0) {
                    const w = workers.find(x => x.id === wid);
                    const pay = val * w.rate;
                    totalEarn += pay;
                    totalAdv += adv;
                    attData.push({ wid, name: w.name, val, pay, adv });
                }
            });

            const rec = {
                id: Date.now(), type: 'work', date, site,
                matIn: document.getElementById('matIn').value,
                matOut: document.getElementById('matOut').value,
                desc: document.getElementById('workDesc').value,
                img: document.getElementById('imgData').value,
                attData, totalEarn, totalAdv
            };

            const all = getData('svle_records');
            all.push(rec);
            localStorage.setItem('svle_records', JSON.stringify(all));
            
            alert("✅ Saved!");
            location.reload(); // Refresh to clear
        } catch(e) {
            alert("❌ MEMORY FULL! Reset button dabao.");
        }
    }

    function savePayment() {
        try {
            const wid = document.getElementById('payWorker').value;
            const amt = document.getElementById('payAmt').value;
            const date = document.getElementById('payDate').value;
            if(!wid || !amt) return alert("Select Worker & Amount");
            
            const wName = document.getElementById('payWorker').options[document.getElementById('payWorker').selectedIndex].text;
            
            const rec = { id: Date.now(), type: 'pay', wid, wName, amt, date };
            const all = getData('svle_records');
            all.push(rec);
            localStorage.setItem('svle_records', JSON.stringify(all));
            
            alert("✅ Payment Saved!");
            renderUI();
        } catch(e) { alert("Memory Full"); }
    }

    function delRec(id) {
        if(confirm("Delete this?")) {
            const all = getData('svle_records').filter(x => x.id !== id);
            localStorage.setItem('svle_records', JSON.stringify(all));
            renderUI();
        }
    }

    function makeBill() {
        const wid = document.getElementById('billWorker').value;
        if(!wid) return alert("Worker select karo");

        const wName = document.getElementById('billWorker').options[document.getElementById('billWorker').selectedIndex].text;
        const recs = getData('svle_records');

        let days = 0, earned = 0, advTaken = 0, cashPaid = 0;
        let payList = "";

        recs.forEach(r => {
            if(r.type === 'work') {
                const h = r.attData.find(x => x.wid == wid);
                if(h) {
                    days += parseFloat(h.val);
                    earned += parseFloat(h.pay);
                    advTaken += parseFloat(h.adv);
                }
            } else if(r.type === 'pay' && r.wid == wid) {
                cashPaid += parseFloat(r.amt);
                payList += `<li>${r.date}: ₹${r.amt}</li>`;
            }
        });

        const net = earned - advTaken - cashPaid;

        document.getElementById('billArea').innerHTML = `
            <div style="text-align:center;">
                <h3>SHREE VAIBHAV LAXMI ENT.</h3>
                <p>Statement: ${wName}</p>
            </div>
            <hr>
            <p><b>Total Days:</b> ${days}</p>
            <p style="color:green"><b>Total Kamayi:</b> ₹${earned}</p>
            <p style="color:red"><b>(-) Daily Advance:</b> ₹${advTaken}</p>
            <p style="color:#e65100"><b>(-) Cash Given:</b> ₹${cashPaid}</p>
            <ul>${payList}</ul>
            <hr>
            <h2 style="text-align:center;">BAKI (Balance): ₹${net}</h2>
            <button onclick="window.print()" class="btn-blue no-print">Print</button>
            <button onclick="document.getElementById('billArea').style.display='none'" class="btn-red no-print">Close</button>
        `;
        document.getElementById('billArea').style.display = 'block';
    }

    function resetAll() {
        if(confirm("Sab delete ho jayega! Pakka?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>
