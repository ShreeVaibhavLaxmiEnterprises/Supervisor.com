<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Enterprises Tracker</title>
    <style>
        :root {
            --primary: #d32f2f;
            --blue-btn: #1976d2;
            --green-btn: #388e3c;
            --purple-btn: #7b1fa2;
            --bg: #f5f5f5;
            --border: #ddd;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* Main Container */
        .app-container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Headers */
        .main-header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .main-header h2 { color: var(--primary); margin: 0; text-transform: uppercase; font-weight: 800; font-size: 1.4rem; }
        .main-header p { color: #555; margin: 5px 0 0; font-size: 0.9rem; font-weight: 600; }

        /* Section Boxes */
        .section-box { background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section-title { font-weight: bold; border-left: 4px solid var(--blue-btn); padding-left: 8px; margin-bottom: 15px; background: #e3f2fd; padding: 5px 8px; }
        .hisab-title { border-left-color: var(--purple-btn); background: #f3e5f5; }

        /* Forms */
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-top: 10px; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; background: #fff; }
        textarea { resize: vertical; }

        /* Buttons */
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-blue { background: var(--blue-btn); }
        .btn-green { background: var(--green-btn); }
        .btn-purple { background: var(--purple-btn); }
        .btn-print { background: #0288d1; width: auto; float: right; padding: 5px 15px; font-size: 0.8rem; margin-top: 0; }
        button:active { transform: scale(0.98); }

        /* Worker Management Toggle */
        #workerFormArea { display: none; background: #e3f2fd; padding: 10px; border: 1px dashed #1976d2; margin-bottom: 15px; }

        /* Grid Layouts */
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Attendance List */
        .attendance-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; border-bottom: 1px solid #eee; }
        .attendance-item input { width: 60px; text-align: center; padding: 5px; margin: 0; border: 2px solid #90caf9; font-weight: bold;}

        /* Saved Records Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background: #eee; }

        /* --- PREMIUM BILL STYLES (Image 2) --- */
        #billResultArea { display: none; margin-top: 20px; border: 2px solid #000; padding: 20px; background: #fff; }
        .bill-header { text-align: center; margin-bottom: 20px; }
        .bill-title { font-size: 1.5rem; font-weight: bold; text-decoration: underline; margin-bottom: 15px; text-align: center; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
        .bill-total-line { border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; font-size: 1.2rem; font-weight: bold; }
        .bill-logo-text { color: var(--primary); font-weight: bold; font-size: 1.2rem; text-align: center; }

        /* Print Logic */
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .app-container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
            #billResultArea { display: block !important; border: 2px solid #000; }
        }
    </style>
</head>
<body>

<div class="app-container">

    <div class="main-header">
        <h2>Shree Vaibhav Laxmi Enterprises</h2>
        <p>Supervisor: Siddharth Yadav | Tracking reports</p>
    </div>

    <div class="no-print">
        <button class="btn-blue" onclick="toggleWorkerForm()">+ Worker Add Karein (Manage List)</button>
        
        <div id="workerFormArea">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="newWorkerName" placeholder="Name (Ex. Raju)">
                <select id="newWorkerType">
                    <option value="Mistri">Mistri</option>
                    <option value="Helper">Helper</option>
                    <option value="Labour">Labour</option>
                </select>
                <input type="number" id="newWorkerRate" placeholder="Rate (₹)" style="width: 80px;">
            </div>
            <button onclick="addWorker()" style="background: #0d47a1; margin-top: 5px;">Save Worker</button>
            <ul id="workerListDisplay" style="margin: 10px 0 0 20px; font-size: 0.9rem;"></ul>
        </div>
    </div>

    <br>

    <div class="section-box no-print">
        <div class="section-title">Daily Entry (रोज़ का काम)</div>

        <label>Date (तारीख):</label>
        <input type="date" id="entryDate">

        <label>Site Name (साइट का नाम):</label>
        <input type="text" id="siteName" placeholder="Example: Gupta Ji House">

        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 15px;">
            <label style="margin-top:0;">Worker Hajari (हाजिरी): <small style="font-weight:normal;">(* 1 = Full, 0.5 = Half)</small></label>
            <div id="attendanceContainer">
                <p style="color:#666; text-align:center;">No workers added yet. (Click + Worker Add above)</p>
            </div>
        </div>

        <div class="row-2">
            <div>
                <label style="color: green;">Maal Aaya (IN):</label>
                <textarea id="matIn" rows="2" placeholder="Cement, Sariya..."></textarea>
            </div>
            <div>
                <label style="color: red;">Maal Laga (OUT):</label>
                <textarea id="matOut" rows="2" placeholder="Slab casting..."></textarea>
            </div>
        </div>

        <label>Aaj ka kaam (Work Description):</label>
        <textarea id="workDesc" rows="2" placeholder="Aaj kya kaam hua..."></textarea>

        <label>Site Photo:</label>
        <input type="file" id="sitePhoto" accept="image/*">

        <button class="btn-green" onclick="saveDailyRecord()">Save Daily Record</button>
    </div>

    <div class="section-box no-print">
        <div class="section-title hisab-title">Hisab Kitab (Calculator)</div>
        
        <label>Select Worker:</label>
        <select id="calcWorker">
            <option value="">Select Worker...</option>
        </select>

        <div class="row-2">
            <div>
                <label>Kab Se (From):</label>
                <input type="date" id="dateFrom">
            </div>
            <div>
                <label>Kab Tak (To):</label>
                <input type="date" id="dateTo">
            </div>
        </div>

        <button class="btn-purple" onclick="generateBill()">Check Hisab (Generate Bill)</button>
    </div>

    <div id="billResultArea">
        </div>

    <div class="section-box">
        <div class="section-title" style="background:#eee; border-left-color:#333; display:flex; justify-content:space-between; align-items:center;">
            Saved Records / PDF Register
            <button class="btn-print no-print" onclick="window.print()">Print / Save PDF</button>
        </div>
        
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th width="20%">Date / Site</th>
                        <th width="40%">Work & Material</th>
                        <th>Worker Payment Details</th>
                        <th class="no-print">Del</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- DATA MANAGEMENT ---
    // Try-Catch block ensures bad data doesn't crash the app
    function getWorkers() { 
        try { return JSON.parse(localStorage.getItem('svle_workers')) || []; } 
        catch(e) { return []; }
    }
    function getRecords() { 
        try { return JSON.parse(localStorage.getItem('svle_records')) || []; } 
        catch(e) { return []; }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        loadWorkerUI();
        loadRecordsTable();
    });

    // --- WORKER FUNCTIONS ---
    function toggleWorkerForm() {
        const div = document.getElementById('workerFormArea');
        div.style.display = div.style.display === 'none' ? 'block' : 'none';
    }

    function addWorker() {
        const name = document.getElementById('newWorkerName').value.trim();
        const type = document.getElementById('newWorkerType').value;
        const rate = document.getElementById('newWorkerRate').value;

        if(!name || !rate) return alert("Worker ka Naam aur Rate dono dalein!");

        const workers = getWorkers();
        workers.push({ id: Date.now(), name, type, rate });
        localStorage.setItem('svle_workers', JSON.stringify(workers));
        
        // Reset inputs
        document.getElementById('newWorkerName').value = '';
        document.getElementById('newWorkerRate').value = '';
        
        alert("Worker Added!");
        loadWorkerUI();
    }

    function loadWorkerUI() {
        const workers = getWorkers();
        const list = document.getElementById('workerListDisplay');
        const attContainer = document.getElementById('attendanceContainer');
        const calcSelect = document.getElementById('calcWorker');

        // 1. List for delete
        if(list) {
            list.innerHTML = workers.map(w => `<li>${w.name} (${w.type}) - ₹${w.rate} <a href="#" onclick="deleteWorker(${w.id})" style="color:red; font-weight:bold;">[Delete]</a></li>`).join('');
        }

        // 2. Attendance Inputs
        if(attContainer) {
            if(workers.length > 0) {
                attContainer.innerHTML = workers.map(w => `
                    <div class="attendance-item">
                        <span><b>${w.name}</b> <small>(₹${w.rate})</small></span>
                        <input type="number" step="0.5" placeholder="0" class="hajari-inp" data-rate="${w.rate}" data-name="${w.name}">
                    </div>
                `).join('');
            } else {
                attContainer.innerHTML = '<p style="text-align:center; color:#777;">Koi worker nahi hai. Upar "+ Worker Add" par click karein.</p>';
            }
        }

        // 3. Calculator Dropdown
        if(calcSelect) {
            calcSelect.innerHTML = '<option value="">Select Worker...</option>' + workers.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
        }
    }

    function deleteWorker(id) {
        if(confirm("Is Worker ko list se hatana hai?")) {
            const workers = getWorkers().filter(w => w.id !== id);
            localStorage.setItem('svle_workers', JSON.stringify(workers));
            loadWorkerUI();
        }
    }

    // --- SAVE DAILY RECORD (UPDATED FOR STABILITY) ---
    function saveDailyRecord() {
        try {
            const date = document.getElementById('entryDate').value;
            const site = document.getElementById('siteName').value;
            const matIn = document.getElementById('matIn').value;
            const matOut = document.getElementById('matOut').value;
            const workDesc = document.getElementById('workDesc').value;

            // Strict Validation
            if(!date) { alert("Kripya Date (Tareekh) select karein."); return; }
            if(!site) { alert("Kripya Site ka Naam bharein."); return; }

            // Collect Attendance
            const inputs = document.querySelectorAll('.hajari-inp');
            let hajariData = [];
            let totalPay = 0;

            // Loop safely
            if(inputs && inputs.length > 0) {
                inputs.forEach(inp => {
                    const val = parseFloat(inp.value);
                    if(!isNaN(val) && val > 0) {
                        const rate = parseFloat(inp.getAttribute('data-rate')) || 0;
                        const pay = val * rate;
                        hajariData.push({
                            name: inp.getAttribute('data-name'),
                            val: val,
                            pay: pay
                        });
                        totalPay += pay;
                    }
                });
            }

            const record = {
                id: Date.now(),
                date, site, matIn, matOut, workDesc,
                hajariData, totalPay
            };

            const records = getRecords();
            records.push(record);
            localStorage.setItem('svle_records', JSON.stringify(records));

            alert("✅ Record Save Ho Gaya!");
            
            // Clear Form
            document.getElementById('siteName').value = '';
            document.getElementById('matIn').value = '';
            document.getElementById('matOut').value = '';
            document.getElementById('workDesc').value = '';
            if(inputs) inputs.forEach(i => i.value = '');
            
            loadRecordsTable();

        } catch (error) {
            console.error(error);
            alert("Error: Data save nahi ho paya. Storage full ho sakti hai.");
        }
    }

    // --- LOAD TABLE ---
    function loadRecordsTable() {
        const records = getRecords().sort((a,b) => new Date(b.date) - new Date(a.date));
        const tbody = document.getElementById('recordsTableBody');
        tbody.innerHTML = '';

        if(records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">Abhi koi record nahi hai.</td></tr>';
            return;
        }

        records.forEach(r => {
            // Safety check for hajariData
            const safeHajari = r.hajariData || [];
            let workerHtml = safeHajari.map(h => `<div>${h.name} (${h.val}): <b>₹${h.pay}</b></div>`).join('');
            
            if(!workerHtml) workerHtml = '<span style="color:#aaa;">No Workers</span>';

            const row = `
                <tr>
                    <td><b>${r.date}</b><br>${r.site}</td>
                    <td>
                        ${r.workDesc ? `<div><b>Work:</b> ${r.workDesc}</div>` : ''}
                        ${r.matIn ? `<div style="color:green; font-size:0.8rem;">IN: ${r.matIn}</div>` : ''}
                        ${r.matOut ? `<div style="color:red; font-size:0.8rem;">OUT: ${r.matOut}</div>` : ''}
                    </td>
                    <td>
                        ${workerHtml}
                        <div style="border-top:1px dashed #ccc; margin-top:5px; font-weight:bold;">Total: ₹${r.totalPay || 0}</div>
                    </td>
                    <td class="no-print">
                        <button style="background:#c62828; padding:5px 8px; font-size:12px; margin-top:0;" onclick="deleteRecord(${r.id})">Delete</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function deleteRecord(id) {
        if(confirm("Kya aap is record ko delete karna chahte hain?")) {
            const records = getRecords().filter(r => r.id !== id);
            localStorage.setItem('svle_records', JSON.stringify(records));
            loadRecordsTable();
        }
    }

    // --- GENERATE PREMIUM BILL ---
    function generateBill() {
        const workerId = document.getElementById('calcWorker').value;
        const selectBox = document.getElementById('calcWorker');
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;

        if(!workerId) return alert("Pehle Worker select karein!");
        
        const workerName = selectBox.options[selectBox.selectedIndex].text;
        const records = getRecords();
        
        let totalDays = 0;
        let totalHajari = 0;
        let totalMoney = 0;

        // Filter Data
        const filtered = records.filter(r => {
            if(from && r.date < from) return false;
            if(to && r.date > to) return false;
            return true;
        });

        filtered.forEach(r => {
            const safeHajari = r.hajariData || [];
            const entry = safeHajari.find(h => h.name === workerName);
            if(entry) {
                totalDays++; 
                totalHajari += parseFloat(entry.val);
                totalMoney += parseFloat(entry.pay);
            }
        });

        if(totalDays === 0) {
            alert("Is worker ka koi record nahi mila is date range me.");
            return;
        }

        // Bill HTML
        const billHtml = `
            <div class="bill-header">
                <div class="bill-logo-text">Shree Vaibhav Laxmi Enterprises</div>
                <div style="font-size:0.9rem;">Supervisor : Siddharth Yadav</div>
            </div>
            <hr style="border-top: 2px solid #000;">
            
            <div class="bill-title">PAYMENT BILL</div>

            <div style="margin-bottom: 20px;">
                <div class="bill-row"><b>Bill No:</b> ${Math.floor(1000 + Math.random() * 9000)}</div>
                <div class="bill-row"><b>Worker:</b> ${workerName}</div>
                <div class="bill-row"><b>Date Range:</b> ${from || 'Shuru'} se ${to || 'Aaj Tak'}</div>
            </div>

            <div class="bill-row">
                <span>Total Days Worked (Din)</span>
                <span>${totalDays}</span>
            </div>
            <div class="bill-row">
                <span>Total Hajari Count</span>
                <span>${totalHajari}</span>
            </div>

            <div class="bill-total-line bill-row">
                <span>TOTAL AMOUNT</span>
                <span>₹ ${totalMoney}</span>
            </div>

            <div style="text-align:center; margin-top:30px;">
                <button class="no-print btn-blue" onclick="document.getElementById('billResultArea').style.display='none'">Close Bill</button>
                <button class="no-print btn-print" onclick="window.print()" style="float:none; display:inline-block; width:auto; margin-top:10px;">Print Bill</button>
            </div>
        `;

        const area = document.getElementById('billResultArea');
        area.innerHTML = billHtml;
        area.style.display = 'block';
        area.scrollIntoView({behavior: "smooth"});
    }
</script>

</body>
</html>
