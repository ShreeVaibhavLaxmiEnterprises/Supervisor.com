<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nirmal Enterprise - Auto App</title>
    <style>
        /* --- PREMIUM CSS STYLING --- */
        body { font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; margin: 0; padding: 15px; background-color: #f0f4f8; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header Card */
        .header-card { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin-bottom: 20px; }
        h1 { margin: 0; font-size: 26px; text-transform: uppercase; letter-spacing: 1.5px; }
        .sub-header { font-size: 14px; opacity: 0.9; margin-top: 5px; }

        /* Tabs */
        .tabs { display: flex; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: white; cursor: pointer; font-size: 16px; font-weight: 700; color: #555; transition: 0.3s; }
        .tab-btn.active { background: #e67e22; color: white; }
        
        /* Cards */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-left: 6px solid #1e3c72; }
        .card-title { font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card-work { border-left-color: #27ae60; }
        .card-material { border-left-color: #f39c12; }

        /* Inputs & Tables */
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: #fff; }
        input:focus, select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; color: #475569; padding: 12px; font-size: 13px; text-align: center; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        tr:last-child td { border-bottom: none; }
        
        /* Specific Column Styles */
        .col-name input { font-weight: bold; color: #2d3748; }
        .col-total input { background-color: #ebf8ff; color: #2b6cb0; font-weight: bold; border: 1px solid #bee3f8; }

        /* Summary Tags */
        .summary-box { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; background: #edf2f7; padding: 10px; border-radius: 8px; }
        .tag { background: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; color: #4a5568; border: 1px solid #cbd5e0; }
        .tag span { color: #e67e22; }

        /* Buttons */
        .btn-add { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-save { background: linear-gradient(to right, #1e3c72, #2a5298); width: 100%; padding: 16px; color: white; font-size: 18px; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3); }
        .btn-print { background: #e67e22; width: 100%; padding: 12px; color: white; font-size: 16px; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        .btn-del { color: #e53e3e; background: #fff0f0; border: 1px solid #feb2b2; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; line-height: 1; }

        /* Photos & Signatures */
        .photo-btn { background: #f0fff4; color: #276749; border: 2px dashed #48bb78; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; display: block; font-weight: 600; margin-top: 10px; }
        .photo-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .photo-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        canvas { border: 2px dashed #cbd5e0; background: #fff; cursor: crosshair; width: 100%; height: 100px; border-radius: 6px; }

        /* Print Hiding */
        @media print {
            .tabs, .btn-add, .btn-save, .btn-print, .photo-btn, #dbSection, .btn-del { display: none !important; }
            body, .container { background: white; margin: 0; padding: 0; max-width: 100%; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; margin-bottom: 10px; }
            .header-card { background: white; color: black; border-bottom: 2px solid black; padding: 10px; box-shadow: none; }
            input, select, textarea { border: none; background: transparent; padding: 5px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header-card">
        <h1>NIRMAL ENTERPRISE</h1>
        <div class="sub-header">Shuttering Contractor | Ghatkopar, Mumbai | Mob: 9167004003</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('entry')">üìù Daily Entry</button>
        <button class="tab-btn" onclick="switchTab('db')">üîç Saved Records</button>
    </div>

    <div id="entrySection" style="display:block;">
        <form id="reportForm">
            
            <div class="card">
                <div class="card-title">üìç Site Details</div>
                <div style="display:flex; gap:15px;">
                    <div style="flex:1"><label>Date</label><input type="date" id="mainDate"></div>
                    <div style="flex:1"><label>Site Name</label><input type="text" id="siteName" placeholder="e.g. Building A"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-title" style="display:flex; justify-content:space-between;">
                    <span>üë∑ Labour Muster Roll</span>
                    <span style="font-size:14px; color:#e67e22;">Today's Payable: ‚Çπ<span id="grandTotal">0</span></span>
                </div>
                
                <div class="summary-box">
                    <div class="tag">Carp: <span id="cCarp">0</span></div>
                    <div class="tag">Fit: <span id="cFit">0</span></div>
                    <div class="tag">Help: <span id="cHelp">0</span></div>
                    <div class="tag">Total Workers: <span id="cTotal">0</span></div>
                </div>

                <div class="table-wrapper">
                    <table id="labourTable">
                        <thead>
                            <tr>
                                <th width="25%">Worker Name</th>
                                <th width="15%">Type</th>
                                <th width="12%">Rate (‚Çπ)</th>
                                <th width="10%">Att.</th>
                                <th width="15%">Adv. (‚Çπ)</th>
                                <th width="15%">Payable (‚Çπ)</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button type="button" class="btn-add" onclick="addWorkerRow()">+ Add New Worker</button>
            </div>

            <div class="card card-material">
                <div class="card-title">üß± Material Report</div>
                <textarea id="materialBox" rows="3" placeholder="Example: 50 Ply Sheets In, 20 Props Out..."></textarea>
            </div>

            <div class="card card-work">
                <div class="card-title">üèóÔ∏è Work Done Description</div>
                <textarea id="workBox" rows="3" placeholder="Describe work progress..."></textarea>
                
                <label class="photo-btn">
                    üì∑ Click to Attach Site Photos
                    <input type="file" accept="image/*" multiple onchange="previewImages(this)" style="display:none;">
                </label>
                <div class="photo-grid" id="photoContainer"></div>
            </div>

            <div class="card">
                <div class="card-title">‚ö†Ô∏è Issues / Requirements</div>
                <textarea id="issueBox" rows="2" placeholder="Urgent needs..."></textarea>
            </div>

            <div class="card" style="page-break-inside: avoid;">
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">
                        <label>Supervisor Signature</label>
                        <canvas id="sigCanvas1"></canvas>
                        <button type="button" onclick="clearCanvas('sigCanvas1')" style="font-size:11px; padding:2px 5px;">Clear</button>
                    </div>
                    <div style="flex:1;">
                        <label>Engineer/Client Signature</label>
                        <canvas id="sigCanvas2"></canvas>
                        <button type="button" onclick="clearCanvas('sigCanvas2')" style="font-size:11px; padding:2px 5px;">Clear</button>
                    </div>
                </div>
            </div>

            <button type="button" class="btn-save" onclick="saveToDatabase()">üíæ SAVE DATA & UPDATE WORKER LIST</button>
            <button type="button" class="btn-print" onclick="window.print()">üñ®Ô∏è SAVE AS PDF</button>

        </form>
    </div>

    <div id="dbSection" style="display:none;">
        <div class="card">
            <div class="card-title">
                üîç Search Old Records
                <button onclick="downloadExcel()" style="background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:12px; cursor:pointer; float:right;">‚¨á Download Excel</button>
            </div>
            <input type="text" id="searchInput" placeholder="Search by Name or Date..." onkeyup="searchDatabase()" style="margin-bottom:15px;">
            <div class="table-wrapper">
                <table id="searchTable">
                    <thead>
                        <tr><th>Date</th><th>Name</th><th>Type</th><th>Site</th><th>Rate</th><th>Att</th><th>Payable</th></tr>
                    </thead>
                    <tbody id="dbBody"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    document.getElementById('mainDate').valueAsDate = new Date();

    // --- INITIAL LOAD & TEAM MEMORY ---
    window.onload = function() {
        loadMyTeam(); // This is the magic function
        loadDatabase();
        setupCanvas('sigCanvas1');
        setupCanvas('sigCanvas2');
    };

    function loadMyTeam() {
        // Check if we have a saved team list
        const savedTeam = JSON.parse(localStorage.getItem('nirmalFixedTeam'));
        const table = document.getElementById("labourTable").getElementsByTagName('tbody')[0];
        
        if (savedTeam && savedTeam.length > 0) {
            // Load saved workers
            savedTeam.forEach(worker => {
                addWorkerRow(worker.name, worker.type, worker.rate);
            });
        } else {
            // If new, add one blank row
            addWorkerRow();
        }
    }

    // --- ROW LOGIC ---
    function addWorkerRow(name = '', type = 'Carpenter', rate = '') {
        const table = document.getElementById("labourTable").getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        newRow.innerHTML = `
            <td class="col-name"><input type="text" class="w-name" value="${name}" placeholder="Name"></td>
            <td>
                <select class="w-type" onchange="updateCounts()">
                    <option ${type==='Carpenter'?'selected':''}>Carpenter</option>
                    <option ${type==='Fitter'?'selected':''}>Fitter</option>
                    <option ${type==='Helper'?'selected':''}>Helper</option>
                    <option ${type==='Other'?'selected':''}>Other</option>
                </select>
            </td>
            <td><input type="number" class="rate" value="${rate}" oninput="calcRow(this)" placeholder="0"></td>
            <td><input type="number" class="att" oninput="calcRow(this)" placeholder="1" step="0.5"></td>
            <td><input type="number" class="adv" oninput="calcRow(this)" placeholder="0"></td>
            <td class="col-total"><input type="number" class="total" readonly value="0"></td>
            <td><button type="button" class="btn-del" onclick="removeRow(this)">√ó</button></td>
        `;
        if(rate) calcRow(newRow.querySelector('.rate')); // Auto calc if loading
        updateCounts();
    }

    function removeRow(btn) {
        if(confirm("Remove this worker from list?")) {
            btn.closest('tr').remove();
            updateCounts();
        }
    }

    // --- CALCULATION LOGIC ---
    function calcRow(el) {
        const row = el.closest('tr');
        const rate = parseFloat(row.querySelector('.rate').value) || 0;
        const att = parseFloat(row.querySelector('.att').value) || 0;
        const adv = parseFloat(row.querySelector('.adv').value) || 0;
        
        const total = (rate * att) - adv;
        row.querySelector('.total').value = total;
        
        updateCounts(); // Update Grand Total
    }

    function updateCounts() {
        let counts = {Carpenter:0, Fitter:0, Helper:0, Other:0};
        let grandTotal = 0;
        
        document.querySelectorAll('#labourTable tbody tr').forEach(row => {
            const type = row.querySelector('.w-type').value;
            const pay = parseFloat(row.querySelector('.total').value) || 0;
            counts[type]++;
            grandTotal += pay;
        });

        document.getElementById('cCarp').innerText = counts.Carpenter;
        document.getElementById('cFit').innerText = counts.Fitter;
        document.getElementById('cHelp').innerText = counts.Helper;
        document.getElementById('cTotal').innerText = counts.Carpenter + counts.Fitter + counts.Helper + counts.Other;
        document.getElementById('grandTotal').innerText = grandTotal;
    }

    // --- SAVE LOGIC (KEY FEATURE) ---
    function saveToDatabase() {
        if(!confirm("Save Data? This will update your daily worker list.")) return;

        const date = document.getElementById('mainDate').value;
        const site = document.getElementById('siteName').value || "-";
        let newRecords = [];
        let currentTeamList = []; // List to remember for tomorrow

        document.querySelectorAll('#labourTable tbody tr').forEach(row => {
            const name = row.querySelector('.w-name').value.trim();
            const type = row.querySelector('.w-type').value;
            const rate = row.querySelector('.rate').value;
            
            if(name) {
                // 1. Data for History
                newRecords.push({
                    date: date, site: site, name: name, type: type,
                    rate: rate, att: row.querySelector('.att').value,
                    payable: row.querySelector('.total').value
                });

                // 2. Data for Auto-Load (Update the fixed team)
                currentTeamList.push({ name: name, type: type, rate: rate });
            }
        });

        // Save History
        let existing = JSON.parse(localStorage.getItem('nirmalData')) || [];
        localStorage.setItem('nirmalData', JSON.stringify([...newRecords, ...existing]));

        // Save Team for Next Time
        localStorage.setItem('nirmalFixedTeam', JSON.stringify(currentTeamList));

        alert("Data Saved! Your team list has been updated for next time.");
        
        // Clear daily fields but keep the team rows
        document.querySelectorAll('.att').forEach(i => i.value = '');
        document.querySelectorAll('.adv').forEach(i => i.value = '');
        document.querySelectorAll('.total').forEach(i => i.value = '0');
        document.getElementById('photoContainer').innerHTML = "";
        clearCanvas('sigCanvas1'); clearCanvas('sigCanvas2');
    }

    // --- PHOTOS ---
    function previewImages(input) {
        const container = document.getElementById('photoContainer');
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('photo-preview');
                    container.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    // --- SEARCH & TABS ---
    function switchTab(t) {
        document.getElementById('entrySection').style.display = t=='entry' ? 'block' : 'none';
        document.getElementById('dbSection').style.display = t=='db' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-btn')[t=='entry'?0:1].classList.add('active');
        if(t=='db') loadDatabase();
    }

    function loadDatabase(filter="") {
        const tbody = document.getElementById('dbBody'); tbody.innerHTML = "";
        const data = JSON.parse(localStorage.getItem('nirmalData')) || [];
        data.filter(i => (i.name+i.date).toLowerCase().includes(filter.toLowerCase())).forEach(item => {
            tbody.innerHTML += `<tr><td>${item.date}</td><td><b>${item.name}</b></td><td>${item.type}</td><td>${item.site}</td><td>${item.rate}</td><td>${item.att}</td><td>${item.payable}</td></tr>`;
        });
    }
    function searchDatabase() { loadDatabase(document.getElementById('searchInput').value); }
    function downloadExcel() {
        const data = JSON.parse(localStorage.getItem('nirmalData')) || [];
        let csv = "Date,Name,Type,Site,Rate,Att,Payable\n" + data.map(r => `${r.date},${r.name},${r.type},${r.site},${r.rate},${r.att},${r.payable}`).join("\n");
        const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "Nirmal_Data.csv"; link.click();
    }

    // --- CANVAS ---
    function setupCanvas(id) {
        const canvas = document.getElementById(id); const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.offsetWidth; canvas.height = 100;
        let drawing = false;
        function getPos(e) { const r = canvas.getBoundingClientRect(); return { x: (e.clientX||e.touches[0].clientX)-r.left, y: (e.clientY||e.touches[0].clientY)-r.top }; }
        canvas.addEventListener('mousedown', (e)=>{ drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
        canvas.addEventListener('touchstart', (e)=>{ drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
        canvas.addEventListener('mousemove', (e)=>{ if(drawing) { ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); }});
        canvas.addEventListener('touchmove', (e)=>{ if(drawing) { ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); }});
        canvas.addEventListener('mouseup', ()=>drawing=false); canvas.addEventListener('touchend', ()=>drawing=false);
    }
    function clearCanvas(id) { document.getElementById(id).getContext('2d').clearRect(0,0,1000,1000); }
</script>
</body>
</html>
