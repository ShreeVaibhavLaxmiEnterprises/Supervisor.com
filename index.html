<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Vaibhav Laxmi Enterprises - Full System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f4f8; font-family: 'Segoe UI', sans-serif; }
        .brand-blue { background-color: #0056b3; }
        .text-brand { color: #0056b3; }
        .hidden-section { display: none; }
        .saving-indicator { transition: opacity 0.5s; opacity: 0; color: #16a34a; font-weight: bold; font-size: 0.9rem; }
        .saving-indicator.show { opacity: 1; }

        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 brand-blue text-white flex-shrink-0 hidden md:block">
            <div class="p-6 text-center font-bold text-xl border-b border-blue-400">
                <i class="fas fa-building mb-2 text-3xl"></i><br>
                Shree Vaibhav<br>Laxmi Ent.
            </div>
            <nav class="mt-6">
                <a href="#" onclick="showSection('dashboard')" class="block py-3 px-6 hover:bg-blue-700 transition"><i class="fas fa-chart-pie mr-2"></i> Dashboard</a>
                <a href="#" onclick="showSection('dailyEntry')" class="block py-3 px-6 hover:bg-blue-700 transition"><i class="fas fa-hard-hat mr-2"></i> Labour Entry</a>
                <a href="#" onclick="showSection('materialSection')" class="block py-3 px-6 hover:bg-blue-700 transition"><i class="fas fa-truck-loading mr-2"></i> Material / Samaan</a>
                <a href="#" onclick="showSection('workerMaster')" class="block py-3 px-6 hover:bg-blue-700 transition"><i class="fas fa-users-cog mr-2"></i> Worker Setup</a>
                <a href="#" onclick="showSection('reports')" class="block py-3 px-6 hover:bg-blue-700 transition"><i class="fas fa-file-invoice mr-2"></i> Reports</a>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <div class="md:hidden brand-blue text-white p-4 flex justify-between items-center sticky top-0 z-50">
                <span class="font-bold">Shree Vaibhav Laxmi Ent.</span>
                <button onclick="alert('Use Laptop for best experience')" class="text-white"><i class="fas fa-bars"></i></button>
            </div>

            <div class="p-8">

                <div id="dashboard" class="section-content">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-l-4 border-blue-600 pl-3">Project Dashboard</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                            <div class="text-gray-500 text-sm">Labour Cost (This Month)</div>
                            <div class="text-2xl font-bold text-gray-800">₹ <span id="dashLabourCost">0</span></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
                            <div class="text-gray-500 text-sm">Material Cost (This Month)</div>
                            <div class="text-2xl font-bold text-gray-800">₹ <span id="dashMaterialCost">0</span></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-red-500">
                            <div class="text-gray-500 text-sm">Total Expense</div>
                            <div class="text-2xl font-bold text-red-600">₹ <span id="dashTotal">0</span></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                            <div class="text-gray-500 text-sm">Active Workers</div>
                            <div class="text-2xl font-bold text-gray-800" id="dashWorkers">0</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="font-bold text-lg mb-4 text-brand">Quick Actions</h3>
                        <div class="flex gap-4">
                            <button onclick="showSection('dailyEntry')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 shadow flex items-center">
                                <i class="fas fa-user-clock mr-2"></i> Labour Entry
                            </button>
                            <button onclick="showSection('materialSection')" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 shadow flex items-center">
                                <i class="fas fa-cubes mr-2"></i> Material Entry
                            </button>
                        </div>
                    </div>
                </div>

                <div id="materialSection" class="section-content hidden-section">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-l-4 border-yellow-500 pl-3">Material Tracker (Samaan)</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg h-fit border-t-4 border-yellow-500">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Add Material Entry</h3>
                            <form id="materialForm" onsubmit="saveMaterial(event)">
                                <div class="mb-3">
                                    <label class="block text-sm font-bold text-gray-600">Date</label>
                                    <input type="date" id="matDate" class="w-full p-2 border rounded" required>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-bold text-gray-600">Site Name</label>
                                    <input type="text" id="matSite" class="w-full p-2 border rounded" placeholder="e.g. Gomti Nagar" required>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-bold text-gray-600">Item Name</label>
                                    <select id="matItem" class="w-full p-2 border rounded">
                                        <option value="Cement">Cement (Bags)</option>
                                        <option value="Saria">Saria/Steel (Kg/Ton)</option>
                                        <option value="Balu">Balu/Sand (Ft)</option>
                                        <option value="Gitti">Gitti/Aggregate (Ft)</option>
                                        <option value="Diesel">Diesel (Ltr)</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-600">Quantity</label>
                                        <input type="number" id="matQty" class="w-full p-2 border rounded" placeholder="Qty" required oninput="calcMatTotal()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-600">Rate</label>
                                        <input type="number" id="matRate" class="w-full p-2 border rounded" placeholder="Rate" required oninput="calcMatTotal()">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-bold text-gray-600">Total Amount</label>
                                    <input type="number" id="matTotal" class="w-full p-2 border rounded bg-gray-100 font-bold text-blue-800" readonly>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-bold text-gray-600">Supplier/Shop Name</label>
                                    <input type="text" id="matSupplier" class="w-full p-2 border rounded" placeholder="e.g. Gupta Hardware">
                                </div>
                                <button type="submit" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700 font-bold">Save Material</button>
                            </form>
                        </div>

                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Recent Materials</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-gray-100">
                                        <tr class="text-gray-600 text-sm">
                                            <th class="p-3">Date</th>
                                            <th class="p-3">Site</th>
                                            <th class="p-3">Item</th>
                                            <th class="p-3">Qty @ Rate</th>
                                            <th class="p-3">Total (₹)</th>
                                            <th class="p-3">Supplier</th>
                                            <th class="p-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="materialListBody">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dailyEntry" class="section-content hidden-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-blue-600 pl-3">Labour Entry</h2>
                        <span id="autoSaveMsg" class="saving-indicator"><i class="fas fa-check-circle"></i> Auto-saved</span>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                        <form id="dailyReportForm" onsubmit="saveDailyReport(event)">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-lg" onchange="triggerAutoSave()">
                                <div><label class="block text-sm font-bold">Date</label><input type="date" id="reportDate" class="w-full p-2 border rounded bg-white" required></div>
                                <div><label class="block text-sm font-bold">Site Name</label><input type="text" id="siteName" class="w-full p-2 border rounded bg-white" required></div>
                                <div><label class="block text-sm font-bold">Supervisor</label><input type="text" id="supervisor" class="w-full p-2 border rounded bg-white" value="Sidhu Ji"></div>
                            </div>
                            <div class="overflow-x-auto mb-4">
                                <table class="w-full border" id="entryTable">
                                    <thead class="bg-gray-200">
                                        <tr><th class="p-2 w-1/3">Worker Name</th><th class="p-2">Att.</th><th class="p-2">Rate</th><th class="p-2">OT</th><th class="p-2">Adv</th><th class="p-2">Del</th></tr>
                                    </thead>
                                    <tbody id="entryRows" oninput="triggerAutoSave()" onchange="triggerAutoSave()"></tbody>
                                </table>
                            </div>
                            <div class="flex justify-between mt-4">
                                <button type="button" onclick="addEntryRow()" class="bg-green-600 text-white px-4 py-2 rounded"><i class="fas fa-plus"></i> Add</button>
                                <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded font-bold shadow-lg">Final Save</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="workerMaster" class="section-content hidden-section">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-l-4 border-blue-600 pl-3">Worker Setup</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                            <h3 class="font-bold text-lg mb-4">Add Worker</h3>
                            <form id="workerForm" onsubmit="saveWorker(event)">
                                <div class="mb-4"><label class="block text-sm font-medium">Name</label><input type="text" id="wName" class="w-full p-2 border rounded mt-1" required></div>
                                <div class="mb-4"><label class="block text-sm font-medium">Type</label><select id="wType" class="w-full p-2 border rounded"><option value="Mistri">Mistri</option><option value="Labour">Labour</option></select></div>
                                <div class="mb-4"><label class="block text-sm font-medium">Rate</label><input type="number" id="wRate" class="w-full p-2 border rounded mt-1" required></div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Save</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-100"><tr><th class="p-3">Name</th><th class="p-3">Type</th><th class="p-3">Rate</th><th class="p-3">Action</th></tr></thead>
                                <tbody id="workerListBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="reports" class="section-content hidden-section">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-l-4 border-blue-600 pl-3">Salary Slip</h2>
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex gap-4 no-print">
                        <input type="month" id="filterMonth" class="p-2 border rounded">
                        <select id="reportWorkerSelect" class="p-2 border rounded w-64"></select>
                        <button onclick="generateReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Generate</button>
                    </div>
                    <div id="printableArea" class="bg-white p-8 rounded-xl shadow-lg border hidden">
                        <div class="text-center border-b-2 border-blue-600 pb-4 mb-6">
                            <h1 class="text-3xl font-bold text-blue-800 uppercase">Shree Vaibhav Laxmi Enterprises</h1>
                            <p>Supervisor Construction Track Report</p>
                        </div>
                        <div class="flex justify-between mb-4">
                            <p><strong>Name:</strong> <span id="slipName"></span></p>
                            <p><strong>Month:</strong> <span id="slipMonth"></span></p>
                        </div>
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead class="bg-gray-100"><tr><th class="border p-2">Date</th><th class="border p-2">Site</th><th class="border p-2">Rate</th><th class="border p-2">Att.</th><th class="border p-2">Total</th><th class="border p-2 text-red-600">Adv</th></tr></thead>
                            <tbody id="slipBody"></tbody>
                            <tfoot class="bg-blue-50 font-bold">
                                <tr><td colspan="4" class="text-right p-2">Net Payable:</td><td colspan="2" class="p-2 text-blue-800 text-lg" id="slipNetPayable">0</td></tr>
                            </tfoot>
                        </table>
                    </div>
                    <button onclick="window.print()" class="mt-4 bg-gray-800 text-white px-6 py-2 rounded no-print">Print PDF</button>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- DATA ---
        let workers = JSON.parse(localStorage.getItem('svle_workers')) || [];
        let reports = JSON.parse(localStorage.getItem('svle_reports')) || [];
        let materials = JSON.parse(localStorage.getItem('svle_materials')) || [];

        // --- GLOBAL & NAV ---
        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(d => d.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            if(id === 'dailyEntry') checkDraft();
            if(id === 'reports') populateWorkerDropdown('reportWorkerSelect');
            if(id === 'materialSection') renderMaterialList();
            if(id === 'dashboard') updateDashboard();
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            // Calc Labour Cost
            let labourCost = 0;
            reports.filter(r => r.date.startsWith(currentMonth)).forEach(r => {
                r.entries.forEach(e => labourCost += (e.rate * e.attendance) + e.ot);
            });

            // Calc Material Cost
            let matCost = 0;
            materials.filter(m => m.date.startsWith(currentMonth)).forEach(m => {
                matCost += parseFloat(m.total);
            });

            document.getElementById('dashLabourCost').innerText = labourCost;
            document.getElementById('dashMaterialCost').innerText = matCost;
            document.getElementById('dashTotal').innerText = labourCost + matCost;
            document.getElementById('dashWorkers').innerText = workers.length;
        }

        // --- MATERIAL LOGIC (NEW) ---
        function calcMatTotal() {
            const qty = document.getElementById('matQty').value;
            const rate = document.getElementById('matRate').value;
            document.getElementById('matTotal').value = (qty * rate).toFixed(2);
        }

        function saveMaterial(e) {
            e.preventDefault();
            const material = {
                id: Date.now(),
                date: document.getElementById('matDate').value,
                site: document.getElementById('matSite').value,
                item: document.getElementById('matItem').value,
                qty: document.getElementById('matQty').value,
                rate: document.getElementById('matRate').value,
                total: document.getElementById('matTotal').value,
                supplier: document.getElementById('matSupplier').value
            };
            materials.push(material);
            localStorage.setItem('svle_materials', JSON.stringify(materials));
            alert('Material Saved!');
            document.getElementById('materialForm').reset();
            renderMaterialList();
        }

        function renderMaterialList() {
            const tbody = document.getElementById('materialListBody');
            tbody.innerHTML = '';
            // Show last 10 entries reverse
            materials.slice().reverse().slice(0, 10).forEach((m, idx) => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-sm">${m.date}</td>
                        <td class="p-3 text-sm font-bold">${m.site}</td>
                        <td class="p-3 text-sm">${m.item}</td>
                        <td class="p-3 text-sm">${m.qty} x ${m.rate}</td>
                        <td class="p-3 text-sm font-bold text-blue-700">₹${m.total}</td>
                        <td class="p-3 text-sm text-gray-500">${m.supplier}</td>
                        <td class="p-3"><button onclick="deleteMaterial(${m.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        function deleteMaterial(id) {
            if(confirm('Delete this material entry?')) {
                materials = materials.filter(m => m.id !== id);
                localStorage.setItem('svle_materials', JSON.stringify(materials));
                renderMaterialList();
                updateDashboard();
            }
        }

        // --- WORKER MASTER ---
        function saveWorker(e) {
            e.preventDefault();
            workers.push({
                id: Date.now(),
                name: document.getElementById('wName').value,
                type: document.getElementById('wType').value,
                rate: document.getElementById('wRate').value
            });
            localStorage.setItem('svle_workers', JSON.stringify(workers));
            alert('Worker Saved');
            document.getElementById('workerForm').reset();
            renderWorkerList();
        }
        function renderWorkerList() {
            const tbody = document.getElementById('workerListBody'); tbody.innerHTML = '';
            workers.forEach((w, i) => tbody.innerHTML += `<tr class="border-b"><td class="p-3">${w.name}</td><td class="p-3">${w.type}</td><td class="p-3">₹${w.rate}</td><td class="p-3"><button onclick="delWork(${i})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`);
        }
        function delWork(i) { workers.splice(i, 1); localStorage.setItem('svle_workers', JSON.stringify(workers)); renderWorkerList(); }

        // --- DAILY LABOUR ENTRY ---
        function addEntryRow(data=null) {
            const tbody = document.getElementById('entryRows');
            const tr = document.createElement('tr'); tr.className = "bg-white border-b";
            tr.innerHTML = `<td class="p-2"><select class="w-full p-2 border rounded ws" onchange="autoFillRate(this)"><option value="">Select...</option></select></td>
                <td class="p-2"><select class="w-full p-2 border rounded att"><option value="1">Full</option><option value="0.5">Half</option><option value="0">Abs</option></select></td>
                <td class="p-2"><input type="number" class="w-full p-2 border rounded rate" placeholder="0"></td>
                <td class="p-2"><input type="number" class="w-full p-2 border rounded ot" placeholder="0"></td>
                <td class="p-2"><input type="number" class="w-full p-2 border rounded adv" placeholder="0"></td>
                <td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove();triggerAutoSave()" class="text-red-500"><i class="fas fa-times"></i></button></td>`;
            tbody.appendChild(tr);
            const sel = tr.querySelector('.ws');
            workers.forEach(w => { const o = document.createElement('option'); o.value=w.id; o.text=w.name; o.dataset.rate=w.rate; sel.appendChild(o); });
            if(data) { sel.value=data.id; tr.querySelector('.att').value=data.att; tr.querySelector('.rate').value=data.rate; tr.querySelector('.ot').value=data.ot; tr.querySelector('.adv').value=data.adv; }
        }
        function autoFillRate(s) { const r = s.closest('tr').querySelector('.rate'); const o = s.options[s.selectedIndex]; if(o.dataset.rate) r.value=o.dataset.rate; triggerAutoSave(); }
        function triggerAutoSave() {
            const rows=[]; document.querySelectorAll('#entryRows tr').forEach(r=>{ rows.push({ id:r.querySelector('.ws').value, att:r.querySelector('.att').value, rate:r.querySelector('.rate').value, ot:r.querySelector('.ot').value, adv:r.querySelector('.adv').value }); });
            localStorage.setItem('svle_draft', JSON.stringify({ d:document.getElementById('reportDate').value, s:document.getElementById('siteName').value, r:rows }));
            const msg=document.getElementById('autoSaveMsg'); msg.classList.add('show'); setTimeout(()=>msg.classList.remove('show'),2000);
        }
        function checkDraft() {
            const d = JSON.parse(localStorage.getItem('svle_draft')); const tb = document.getElementById('entryRows');
            if(d && tb.children.length===0) { document.getElementById('reportDate').value=d.d; document.getElementById('siteName').value=d.s; d.r.forEach(r=>addEntryRow(r)); }
            else if(tb.children.length===0) addEntryRow();
        }
        function saveDailyReport(e) {
            e.preventDefault();
            const date=document.getElementById('reportDate').value, site=document.getElementById('siteName').value;
            let entries=[];
            document.querySelectorAll('#entryRows tr').forEach(row => {
                const ws = row.querySelector('.ws');
                if(ws.value) entries.push({ workerId: ws.value, workerName: ws.options[ws.selectedIndex].text, attendance: parseFloat(row.querySelector('.att').value), rate: parseFloat(row.querySelector('.rate').value)||0, ot: parseFloat(row.querySelector('.ot').value)||0, adv: parseFloat(row.querySelector('.adv').value)||0 });
            });
            reports.push({ id:Date.now(), date, site, entries });
            localStorage.setItem('svle_reports', JSON.stringify(reports)); localStorage.removeItem('svle_draft');
            alert('Saved!'); e.target.reset(); document.getElementById('entryRows').innerHTML=''; addEntryRow(); updateDashboard();
        }

        // --- REPORTS ---
        function populateWorkerDropdown(id) { const s=document.getElementById(id); s.innerHTML='<option value="">Select Worker</option>'; workers.forEach(w=>{s.innerHTML+=`<option value="${w.id}">${w.name}</option>`}); }
        function generateReport() {
            const wid=document.getElementById('reportWorkerSelect').value, m=document.getElementById('filterMonth').value;
            if(!wid||!m) return alert('Select All Fields');
            const w=workers.find(x=>x.id==wid), f=reports.filter(r=>r.date.startsWith(m));
            let h='', t=0, a=0;
            f.forEach(r=>{ const e=r.entries.find(x=>x.workerId==wid); if(e){ const earn=(e.rate*e.attendance)+e.ot; t+=earn; a+=e.adv; h+=`<tr><td class="border p-2">${r.date}</td><td class="border p-2">${r.site}</td><td class="border p-2">${e.rate}</td><td class="border p-2">${e.attendance}</td><td class="border p-2 text-green-700">${earn}</td><td class="border p-2 text-red-600">${e.adv}</td></tr>`; }});
            document.getElementById('slipName').innerText=w.name; document.getElementById('slipMonth').innerText=m; document.getElementById('slipBody').innerHTML=h; document.getElementById('slipNetPayable').innerText="₹"+(t-a); document.getElementById('printableArea').classList.remove('hidden');
        }

        // Init
        renderWorkerList(); updateDashboard();
    </script>
</body>
</html>
